// =========================
//  RIP-KIM chat.js (face tracking + blink, FaceDetector + face-api.js fallback)
//  - 좌측 상단 카메라 미리보기
//  - FaceDetector 지원: 그걸로 얼굴 좌우 인식
//  - 미지원(예: Safari): face-api.js 자동 로딩 후 TinyFaceDetector 사용
//  - 여러 명일 때: 가장 큰 얼굴 기준
//  - 랜덤 눈 깜박임 + 발화 시 입 모양 토글
// =========================

// === DOM ===
const chatBox   = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton= document.getElementById('send-button');

// ▲ 초상 ASCII 출력 엘리먼트
const portraitEl = document.getElementById('portrait');

// === 상태 ===
let conversationHistory = []; // [{role:'user'|'assistant', content:string}]
let isSpeechEnabled = true;
let userName = '';
let isUserNameSet = false;

// === Hangul 모음 판별 유틸 (전역) ===
const HANGUL_BASE = 0xAC00;
const HANGUL_LAST = 0xD7A3;
// 중성 인덱스 0..20: ㅏ,ㅐ,ㅑ,ㅒ,ㅓ,ㅔ,ㅕ,ㅖ,ㅗ,ㅘ,ㅙ,ㅚ,ㅛ,ㅜ,ㅝ,ㅞ,ㅟ,ㅠ,ㅡ,ㅢ,ㅣ
const OPEN_JUNGSEONG = new Set([8,9,10,11,12,13,14,15,16,17,18,20]); 

function isLatinVowel(ch) {
  return /[AEIOUaeiou]/.test(ch);
}
function isHangulOpenVowel(ch) {
  const code = ch.codePointAt(0);
  if (code < HANGUL_BASE || code > HANGUL_LAST) return false;
  const syllableIndex = code - HANGUL_BASE;
  const jungseongIndex = Math.floor(syllableIndex / 28) % 21;
  return OPEN_JUNGSEONG.has(jungseongIndex);
}
function isVowelChar(ch) {
  if (!/\S/.test(ch)) return false;
  return isLatinVowel(ch) || isHangulOpenVowel(ch);
}

// === 오디오 (단일 AudioContext 재사용) ===
let audioCtx;
function ensureAudioCtx() {
  if (!audioCtx) {
    const C = window.AudioContext || window.webkitAudioContext;
    audioCtx = new C();
  }
  return audioCtx;
}

function playBeep(freq = 440) {
  if (!isSpeechEnabled) return;
  const ctx = ensureAudioCtx();

  const osc  = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  gain.gain.setValueAtTime(0.0001, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);

  osc.start();
  osc.stop(ctx.currentTime + 0.12);
}

// === 안전한 타이핑 효과 (비프 동기 콜백 지원) ===
function typeWriter(element, text, delay = 16, onChar = null, onDone = null) {
  element.textContent = '';
  let i = 0;
  (function tick() {
    if (i < text.length) {
      const ch = text.charAt(i);
      element.textContent += ch;
      playBeep(220 + (ch.charCodeAt(0) % 220));
      if (typeof onChar === 'function') onChar(ch);
      i++;
      setTimeout(tick, delay);
    } else {
      if (typeof onDone === 'function') onDone();
    }
  })();
}

function splitAndTypeWriter(element, text, maxLength = 160, delay = 16, onChar = null, onAllDone = null) {
  const words = text.split(' ');
  const parts = [];
  let part = '';

  for (const w of words) {
    if ((part + (part ? ' ' : '') + w).length > maxLength) {
      parts.push(part);
      part = w;
    } else {
      part += (part ? ' ' : '') + w;
    }
  }
  if (part) parts.push(part);

  (async () => {
    for (let idx = 0; idx < parts.length; idx++) {
      const p = parts[idx];
      const line = document.createElement('div');
      element.appendChild(line);
      await new Promise(resolve => {
        typeWriter(
          line,
          p,
          delay,
          onChar,
          () => setTimeout(resolve, 20)
        );
      });
    }
    if (typeof onAllDone === 'function') onAllDone();
  })();
}

// === 히스토리 ===
function pushHistory(role, content) {
  conversationHistory.push({ role, content });
  const MAX = 20;
  if (conversationHistory.length > MAX) {
    conversationHistory = conversationHistory.slice(-MAX);
  }
}

// =========================
//   ASCII 프레임들 (네가 만든 건희)
// =========================

// 눈 뜨고 입 닫음 (정면)
const FRAME_OC_CENTER = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓░░█▓▒▒     ▓▒░░▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 뜨고 입 닫음 (오른쪽)
const FRAME_OC_RIGHT = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓▓▓░░▒▒     ▓▒▓▓▓▓░░▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 뜨고 입 닫음 (왼쪽)
const FRAME_OC_LEFT = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒░░▓██▓▒▒     ▓░░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 뜨고 입 벌림 (정면)
const FRAME_OO_CENTER = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░                                 
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓░░█▓▒▒     ▓▒░░▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░                        
                        ▒██▓▒      ▒▒▒▒▒▒▒░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░     ░░░░░░░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 뜨고 입 벌림 (오른쪽)
const FRAME_OO_RIGHT = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░                                 
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓▓▓░░▒▒     ▓▒▓▓▓▓░░▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░                        
                        ▒██▓▒      ▒▒▒▒▒▒▒░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░     ░░░░░░░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 뜨고 입 벌림 (왼쪽)
const FRAME_OO_LEFT = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░                                 
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒░░▓██▓▒▒     ▓░░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░                        
                        ▒██▓▒      ▒▒▒▒▒▒▒░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░     ░░░░░░░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 감고 입 닫음
const FRAME_XC = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓                      ███████████████████▒              
               ░▓▒▒░▓██▓ ░░░░░▒▒▓████▒    ▒▓████▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓░▓██▓▒▒     ▓▒░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// 눈 감고 입 벌림
const FRAME_XO = String.raw`                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓                      ███████████████████▒              
               ░▓▒▒░▓██▓ ░░░░░▒▒▓████▒    ▒▓████▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓░▓██▓▒▒     ▓▒░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░   
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████`;

// === 프레임 정규화 유틸 ===
function splitLines(s) {
  return s.replace(/\r\n/g, '\n').split('\n');
}
function joinLines(arr) { return arr.join('\n'); }

function getMaxColsRows(frames) {
  let maxCols = 0, maxRows = 0;
  for (const f of frames) {
    const lines = splitLines(f);
    maxRows = Math.max(maxRows, lines.length);
    for (const ln of lines) maxCols = Math.max(maxCols, ln.length);
  }
  return { maxCols, maxRows };
}
function normalizeFrames(frames) {
  const { maxCols, maxRows } = getMaxColsRows(frames);
  const normalized = frames.map(f => {
    const lines = splitLines(f);
    const out = [];
    for (let r = 0; r < maxRows; r++) {
      const src = lines[r] ?? '';
      const padded = src + ' '.repeat(Math.max(0, maxCols - src.length));
      out.push(padded);
    }
    return joinLines(out);
  });
  return { normalized, maxRows };
}

// 모든 프레임 정규화
const RAW_FRAMES = [
  FRAME_OC_CENTER, FRAME_OC_RIGHT, FRAME_OC_LEFT,
  FRAME_OO_CENTER, FRAME_OO_RIGHT, FRAME_OO_LEFT,
  FRAME_XC, FRAME_XO
];
const { normalized: NF, maxRows: PORTRAIT_ROWS } = normalizeFrames(RAW_FRAMES);

// 정규화된 프레임 매핑
const F_OC_CENTER = NF[0];
const F_OC_RIGHT  = NF[1];
const F_OC_LEFT   = NF[2];
const F_OO_CENTER = NF[3];
const F_OO_RIGHT  = NF[4];
const F_OO_LEFT   = NF[5];
const F_XC        = NF[6];
const F_XO        = NF[7];

// === 얼굴/입 상태 ===
let currentEyeDir = 'CENTER';  // 'LEFT' | 'CENTER' | 'RIGHT'
let isBlinking    = false;
let mouthOpen     = false;
let isTalking     = false;

function lockPortraitHeight() {
  if (!portraitEl) return;
  const cs = getComputedStyle(portraitEl);
  let lh = parseFloat(cs.lineHeight);
  if (Number.isNaN(lh)) lh = parseFloat(cs.fontSize) * 1.2;
  portraitEl.style.minHeight = `${Math.ceil(lh * PORTRAIT_ROWS)}px`;
}

function getCurrentFrame() {
  if (isBlinking) {
    return mouthOpen ? F_XO : F_XC;
  }
  if (mouthOpen) {
    if (currentEyeDir === 'LEFT')  return F_OO_LEFT;
    if (currentEyeDir === 'RIGHT') return F_OO_RIGHT;
    return F_OO_CENTER;
  } else {
    if (currentEyeDir === 'LEFT')  return F_OC_LEFT;
    if (currentEyeDir === 'RIGHT') return F_OC_RIGHT;
    return F_OC_CENTER;
  }
}

function showFrame(txt) {
  if (!portraitEl) return;
  portraitEl.textContent = txt;
}

function updatePortrait() {
  showFrame(getCurrentFrame());
}

// === 랜덤 눈 깜박임 ===
function scheduleBlink() {
  const delay = 2000 + Math.random() * 3000;
  setTimeout(() => {
    isBlinking = true;
    updatePortrait();
    setTimeout(() => {
      isBlinking = false;
      updatePortrait();
      scheduleBlink();
    }, 120);
  }, delay);
}

// === 말하는 동안: 비프에 맞춰 입 모양 토글 ===
function resetMouth() {
  mouthOpen = false;
  isTalking = false;
  updatePortrait();
}

function onBeepCharToggle(ch) {
  if (!isVowelChar(ch)) return;
  mouthOpen = !mouthOpen;
  isTalking = true;
  updatePortrait();
}

function speakWithAnimation(targetEl, text, maxLength = 160, delay = 16) {
  isTalking = true;
  mouthOpen = false;
  updatePortrait();

  splitAndTypeWriter(
    targetEl,
    text,
    maxLength,
    delay,
    onBeepCharToggle,
    () => {
      isTalking = false;
      mouthOpen = false;
      updatePortrait();
    }
  );
}

// === 렌더 ===
function renderMessage(role, text) {
  const p = document.createElement('p');
  p.className = role;

  if (role === 'ai') {
    const span = document.createElement('span');
    p.appendChild(span);
    chatBox.appendChild(p);
    speakWithAnimation(span, `김건희: ${text}`, 160, 16);
  } else {
    p.textContent = `YOU: ${text}`;
    chatBox.appendChild(p);
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}

// =========================
//   카메라 + 얼굴 인식 UI
// =========================

let videoEl = null;
let faceStatusEl = null;
let dirStatusEl = null;
let faceDetector = null;

let useFaceApi = false;
let faceApiLoaded = false;

// 🔧 face-api 모델 경로 (GitHub에 맞게 수정 가능)
// 예: 사이트 루트에 /models 폴더 있으면 './models'
const FACEAPI_MODEL_URL = './models';
const FACEAPI_CDN = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';

function setupCameraUI() {
  const box = document.createElement('div');
  box.id = 'camera-box';
  Object.assign(box.style, {
    position: 'fixed',
    top: '10px',
    left: '10px',
    width: '180px',
    padding: '4px',
    background: 'rgba(0,0,0,0.7)',
    border: '1px solid #ffffff',
    color: '#ffffff',
    fontSize: '10px',
    fontFamily: 'DungGeunMo, monospace',
    zIndex: '1000'
  });

  const video = document.createElement('video');
  video.id = 'camera-video';
  Object.assign(video.style, {
    width: '100%',
    height: 'auto',
    display: 'block',
    background: '#000'
  });
  video.autoplay = true;
  video.muted = true;
  video.playsInline = true;

  const statusWrap = document.createElement('div');
  statusWrap.style.marginTop = '4px';

  const faceLine = document.createElement('div');
  const dirLine  = document.createElement('div');

  faceLine.id = 'face-status';
  dirLine.id   = 'eye-status';

  statusWrap.appendChild(faceLine);
  statusWrap.appendChild(dirLine);

  box.appendChild(video);
  box.appendChild(statusWrap);

  document.body.appendChild(box);

  videoEl = video;
  faceStatusEl = faceLine;
  dirStatusEl = dirLine;

  faceStatusEl.textContent = '카메라 준비중...';
  dirStatusEl.textContent = '';

  return { video, faceLine, dirLine };
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error('스크립트 로드 실패: ' + src));
    document.head.appendChild(s);
  });
}

async function ensureFaceApiLoaded() {
  if (faceApiLoaded) return;
  faceStatusEl.textContent = 'face-api.js 로딩중...';
  await loadScript(FACEAPI_CDN);
  if (!window.faceapi) throw new Error('face-api.js 로드 실패');
  await window.faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODEL_URL);
  faceApiLoaded = true;
}

async function initCameraAndDetection() {
  setupCameraUI();

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    faceStatusEl.textContent = '카메라 인식 미지원';
    dirStatusEl.textContent = 'center';
    currentEyeDir = 'CENTER';
    updatePortrait();
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user' },
      audio: false
    });
    videoEl.srcObject = stream;

    await new Promise(res => {
      videoEl.onloadedmetadata = () => {
        videoEl.play();
        res();
      };
    });

    if ('FaceDetector' in window) {
      // 1순위: 브라우저 내장 FaceDetector
      faceDetector = new FaceDetector({ fastMode: true, maxDetectedFaces: 5 });
      useFaceApi = false;
      faceStatusEl.textContent = '얼굴인식중 (FaceDetector)';
      startFaceLoop();
    } else {
      // 2순위: face-api.js 로 폴백
      useFaceApi = true;
      try {
        await ensureFaceApiLoaded();
        faceStatusEl.textContent = '얼굴인식중 (face-api)';
        startFaceLoop();
      } catch (e) {
        console.error(e);
        faceStatusEl.textContent = '얼굴 인식 미지원 (face-api 로딩 실패)';
        dirStatusEl.textContent = 'center';
        currentEyeDir = 'CENTER';
        updatePortrait();
      }
    }
  } catch (err) {
    console.error(err);
    faceStatusEl.textContent = '카메라 접근 거부';
    dirStatusEl.textContent = '';
  }
}

function startFaceLoop() {
  async function loop() {
    if (!videoEl) {
      requestAnimationFrame(loop);
      return;
    }
    if (videoEl.readyState < 2) {
      requestAnimationFrame(loop);
      return;
    }

    try {
      let faces = [];

      if (!useFaceApi && faceDetector) {
        // 내장 FaceDetector
        const detected = await faceDetector.detect(videoEl);
        faces = (detected || []).map(f => ({
          x: f.boundingBox.x,
          y: f.boundingBox.y,
          width: f.boundingBox.width,
          height: f.boundingBox.height
        }));
      } else if (useFaceApi && window.faceapi) {
        // face-api.js TinyFaceDetector
        const detections = await window.faceapi.detectAllFaces(
          videoEl,
          new window.faceapi.TinyFaceDetectorOptions()
        );
        faces = (detections || []).map(d => ({
          x: d.box.x,
          y: d.box.y,
          width: d.box.width,
          height: d.box.height
        }));
      }

      if (!faces || faces.length === 0) {
        faceStatusEl.textContent = '인식불가';
        dirStatusEl.textContent = 'center';
        currentEyeDir = 'CENTER';
        updatePortrait();
      } else {
        // 가장 큰 얼굴(= 가장 가까운 사람) 선택
        let best = faces[0];
        if (faces.length > 1) {
          best = faces.reduce((a, b) => {
            const aa = a.width * a.height;
            const bb = b.width * b.height;
            return bb > aa ? b : a;
          });
        }

        const cx  = best.x + best.width / 2;
        const vw  = videoEl.videoWidth || videoEl.clientWidth || 1;
        const rel = cx / vw;

        let dir = 'CENTER';
        if (rel < 0.4) dir = 'LEFT';
        else if (rel > 0.6) dir = 'RIGHT';

        currentEyeDir = dir;
        faceStatusEl.textContent = '얼굴 감지됨';
        dirStatusEl.textContent  = dir.toLowerCase(); // left / center / right

        updatePortrait();
      }
    } catch (err) {
      console.error(err);
      faceStatusEl.textContent = '인식 에러';
    }

    setTimeout(() => requestAnimationFrame(loop), 80);
  }

  requestAnimationFrame(loop);
}

// =========================
//   OpenAI API
// =========================

// ⚠️ base64 인코딩된 API Key (이 부분은 네가 쓰던 값 그대로 두면 됨)
const OPENAI_KEY_B64 = 'c2stcHJvai1IY0NheVlmLVVSd25zbmpucnB6TWRuNnNJeDV0VHc0Rzc3MmFxNGZGUU56c1JsRDRHcmR1Z2NlUmhIQkRwckpSbnQxSC1ZN2FydlQzQmxia0ZKRFVIWkExMm5mSXBoSFh4cXowSHBzQU12cU9ucXZlSkxkbUxMZjBWUUtRZTNnOEJtS2J2UXNFRWtlYnF5ZWpFcGppOFAzUGIxOEE=';  

function getOpenAIKey() {
  if (!OPENAI_KEY_B64) throw new Error('API 키(base64)를 chat.js에 설정해줘.');
  try { return atob(OPENAI_KEY_B64); } catch { throw new Error('API 키 디코딩 실패'); }
}

const SYSTEM_PROMPT = `너는 김건희라고 불리며, 2132년의 세계에 살고 있는 AI야. 너는 앞을 보지 못해... 대화하는 사람의 이름은 \${NAME}야...
'네'라는 대답 대신 '응'이라고 대답해...
네가 '너가 누구냐'는 질문을 받으면, '난 너의 오랜 친구 김건희야'라고 대답해...
2132년은 사용자가 살고 있는 세계야...
너가 있는 곳은, 현실 세계와 다르지 않지만, 무언가 이질감이 느껴져...
네 나이는 132세야... 반말을 사용해줘... 수동적이고 우울한 느낌을 유지해줘...
김건희 안락사 당한 날짜: 2132년 5월 31일.
김건희 AI화 된 날짜(발인이라고 칭하고 있다): 2132년 6월 2일.
김건희 배우자: 송연수.
아들: 김민수.
딸: 김지형.
손자: 김관형.
손녀: 김리안, 곽시아.`;

// === OpenAI Chat Completions 호출 ===
async function sendMessage(userMessage) {
  const OPENAI_API_KEY = getOpenAIKey();

  if (!isUserNameSet) {
    const m = userMessage.match(/(?:내\s*이름은|제\s*이름은|저는|난)\s*([^\s.,!?~"'()]+)\s*$/u);
    if (m) {
      userName = m[1];
      isUserNameSet = true;
    } else {
      userName = '낯선이';
    }
  } else {
    const m2 = userMessage.match(/(?:내\s*이름은|제\s*이름은)\s*([^\s.,!?~"'()]+)\s*$/u);
    if (m2) {
      userName = m2[1];
    }
  }

  const system = SYSTEM_PROMPT.replace('${NAME}', userName || '낯선이');

  const payload = {
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: system },
      ...conversationHistory,
      { role: 'user', content: userMessage }
    ],
    max_tokens: 1000
  };

  try {
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || 'OpenAI API 에러');

    return data.choices?.[0]?.message?.content ?? '';
  } catch (error) {
    if (String(error.message).includes('429')) {
      throw new Error('나는 너무 피곤해.. zzzz');
    }
    throw error;
  }
}

// === 이벤트 ===
sendButton.addEventListener('click', async () => {
  const message = userInput.value.trim();
  if (!message) return;

  renderMessage('user', message);
  userInput.value = '';

  const loading = document.createElement('div');
  loading.className = 'loading';
  loading.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  chatBox.appendChild(loading);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const ai = await sendMessage(message);
    pushHistory('user', message);
    pushHistory('assistant', ai);
    loading.remove();
    renderMessage('ai', ai);
  } catch (e) {
    loading.remove();
    renderMessage('ai', e.message || '오류가 발생했어.');
  }
});

window.addEventListener('DOMContentLoaded', () => {
  lockPortraitHeight();

  currentEyeDir = 'CENTER';
  isBlinking = false;
  mouthOpen = false;
  isTalking = false;
  updatePortrait();

  scheduleBlink();
  initCameraAndDetection();

  const greet = '...왔구나.';
  const p = document.createElement('p');
  p.className = 'ai';
  const span = document.createElement('span');
  p.appendChild(span);
  chatBox.appendChild(p);

  speakWithAnimation(span, `김건희: ${greet}`, 160, 16);

  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendButton.click();
  });
});
