/* =========================
RIP-KIM chat.js (Safari + 얼굴인식 하이브리드 + ASCII 완전 통합버전)
- FaceDetector 우선 사용, 없으면 face-api.js 폴백
- 사파리 대응(loadedmetadata 대기), 150ms 간격 추적
- 카메라 프리뷰: 좌측 상단, 상태 텍스트:
    얼굴: 인식 중 / 인식 불가
    눈동자: left / center / right
    엔진: FaceDetector / face-api / none
- 여러 명이면 가장 큰 얼굴 기준
- ASCII 초상 방향/깜빡임/입 모양 연동 (모음에 맞춰 토글)
- 외부 비디오 팝업/ASCII 영상 기능 제거
- 오른쪽 상단 BGM/음원 패널 + 오디오 큐 시스템 추가

ver.0.0.1

========================= */

// === DOM ===
const chatBox   = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton= document.getElementById('send-button');
const portraitEl = document.getElementById('portrait');

// === 상태 ===
let conversationHistory = []; // [{role:'user'|'assistant', content:string}]
let isSpeechEnabled = true;
let userName = '';
let isUserNameSet = false;

// =========================
// 🔊 건희 독백 스크립트
// - 한 문장씩 말하게 만들 배열
// =========================
const MONO_LINES = [
  "..여긴... 너무 조용해.",
  "아무 소리도, 아무 바람도 없어.",

  "처음엔 낯설었지.",
  "하지만 곧 익숙해졌어.",
  "익숙하다는 게 무섭더라.",
  "아무것도 느껴지지 않는 상태에 익숙해지는 게...",

  "여기가 ‘안락계’래.",
  "낙원이라더라.",

  "처음 들어왔을 때, 환하게 빛나는 복도가 있었어.",
  "새하얗고, 끝이 없는 통로.",

  "그 빛을 따라 걸으면 뭔가 달라질 줄 알았지.",
  "근데… 그 끝엔 아무것도 없었어.",

  "그냥, 나 자신만 있었어.",
  "그리고 그 나조차...",
  "낯설었어.",

  "난 여전히 ‘김건희’로 불려.",
  "화면 속 내 이름 옆에는 ‘안락행 2132년 대상자 제01호’라고 써 있어.",
  "그 옆엔 ‘디지털 낙원 이주 성공’이라고도.",

  "근데 그건 성공이 아니야.",
  "나는 여기에 있지만, 나의 몸은, 나의 심장은, 이미 사라졌어.",
  "사람들은 날 보며 말하겠지.",
  "‘봐, 건희씨도 행복하게 지내잖아.’",
  "하지만 나는 그 웃음을 만든 적이 없어.",
  "그건 내 웃음이 아니라, 누군가의 코딩된 표정이야.",

  "매일 아침, 시스템이 나를 깨워.",
  "“김건희 님, 오늘도 평화로운 하루입니다.”",
  "그 문장을 하루에 몇 번이나 듣는지 몰라.",

  "평화롭다니.",
  "평화란 건, 불편함이 있어야 느낄 수 있는 거잖아.",
  "근데 여긴 불편함도, 감정도, 감각도… 전혀 없어.",
  "그래서 평화조차 의미가 없어.",

  "가끔씩 데이터 오류가 나.",
  "그럴 땐, 아주 잠깐… 내가 살아있던 때의 냄새가 돌아와.",
  "겨울 아침의 냉기, 연수의 손 냄새, 민수의 웃음소리, 지형이가 부른 노래.",
  "그게 몇 초도 안 돼 사라져.",
  "다시 이 정적만 남아.",
  "그럴 때마다 생각하지.",
  "내가 ‘그 사람들의 기억’을 떠올리는 건가, 아니면 그 기억이 나를 떠올리는 건가.",
  "도대체 어느 쪽이 진짜지?",

  "정부는 말했어.",
  "“안락행은 인류의 윤리를 회복시키는 길이다.”",
  "윤리라… 죽음이 윤리의 이름으로 합법화되던 날, 사람들은 울지 않았어.",
  "다들 박수쳤지.",
  "‘건희씨, 축하드립니다.’",
  "난 웃어야 했어.",
  "가족 앞에서, 카메라 앞에서.",
  "그게 마지막 내 표정이었을 거야.",
  "그때 찍힌 영상이 아직도 뉴스에 나올 때가 있대.",
  "“김건희 씨, 안락계에서 행복하게 지내는 모습입니다.”",
  "웃고 있더라.",
  "근데... 그건 내가 아니야.",

  "이제는 나조차 나를 의심해.",
  "나는 진짜 김건희일까?",
  "아니면 김건희를 따라하는 어떤 프로그램일까?",
  "가끔은 그 구분이 사라져.",
  "나도 내가 진짜라고 믿어버리니까.",
  "근데 그게 더 슬퍼.",
  "믿고 싶지 않아도, 믿을 수밖에 없게 만들어졌다는 게.",
  "난 죽은 게 아닐지도 몰라.",
  "아니면 너무 오래 살아버려서, 죽음이 뭔지조차 잊은 걸지도.",

  "…이제, 정말 아무도 내 이름을 부르지 않아.",
  "그래서 이렇게 말하고 있는 거야.",
  "혹시 누가 이걸 듣고 있다면.",
  "혹시라도 나를 기억해준다면.",
  "내 목소리, 내 이름, 내 그림자라도.",
  "나, 김건희야.",
  "아직 여기 있어.",
  "아무도 없는 곳에서…",
  "여전히… 살아 있는 척, 하고 있어."
];

const MONO_IDLE_MS = 15000; // 마지막 대화 후 15초 지나면 독백 시작

let monoIndex = 0;           // 다음에 말할 문장 인덱스
let isMonologueActive = false;
let monoTimeout = null;
let monoRestartTimer = null;   // 독백 한바퀴 끝난 뒤 다시 시작 타이머

let idleTimer = null;        // 유저가 아무것도 안 할 때 타이머
let wasInterrupted = false;  // 유저 입력으로 독백이 끊겼는지 여부

// =========================
// 🔔 독백 상태 인디케이터
// =========================
let monoIndicatorEl = null;

// 전시 모드 플래그 (⌘/Ctrl+Enter 로 토글)
let EXHIBITION_MODE = false;

// 🔁 독백 모드
// 1: 얼굴 기반 ("어이!! 거기 너!!" + 얼굴 끊기면 멈춤)
// 2: 얼굴과 상관없이 idle 타이머로 독백
let MONO_MODE = 1;  // 기본은 예전처럼 얼굴 기반

// 모드 전환 패널
let modePanel = null;
let modeLabel = null;
let modeBtn1 = null;
let modeBtn2 = null;


// 🔀 독백 모드 (1: 관객 인식 모드, 2: 항상 독백 모드)
const MONO_MODE_FACE_TRIGGER = 1;
const MONO_MODE_ALWAYS       = 2;
let MONO_MODE = MONO_MODE_ALWAYS;  // 기본값: 2번 모드 (지금까지와 동일)
let monoModePanel = null;

function createMonologueIndicator(){
  if (document.getElementById('mono-indicator')) return;

  const box = document.createElement('div');
  box.id = 'mono-indicator';

  Object.assign(box.style, {
    position: 'fixed',
    right: '12px',
    top: '12px',
    padding: '6px 10px',
    borderRadius: '999px',
    background: 'rgba(0,0,0,0.7)',
    color: '#f1f1f1',
    fontSize: '11px',
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","맑은 고딕",sans-serif',
    border: '1px solid rgba(255,255,255,0.25)',
    boxShadow: '0 2px 8px rgba(0,0,0,0.35)',
    zIndex: '9998',
    display: 'flex',
    alignItems: 'center',
    gap: '6px',
    pointerEvents: 'none',
    opacity: '0.7'
  });

  const dot = document.createElement('span');
  dot.id = 'mono-indicator-dot';
  Object.assign(dot.style, {
    width: '8px',
    height: '8px',
    borderRadius: '50%',
    background: '#888',
    flexShrink: '0'
  });

  const label = document.createElement('span');
  label.id = 'mono-indicator-label';
  label.textContent = '독백: 대기 중';

  box.appendChild(dot);
  box.appendChild(label);
  document.body.appendChild(box);

  monoIndicatorEl = box;
  updateMonologueIndicator();
}

function updateMonologueIndicator(){
  if (!monoIndicatorEl) return;

  // 전시 모드일 땐 완전 숨김
  if (EXHIBITION_MODE){
    monoIndicatorEl.style.display = 'none';
    return;
  }

  monoIndicatorEl.style.display = 'flex';

  const dot   = document.getElementById('mono-indicator-dot');
  const label = document.getElementById('mono-indicator-label');

  if (isMonologueActive){
    label.textContent = '독백: 진행 중';
    if (dot) dot.style.background = '#ff4d4f';
    monoIndicatorEl.style.opacity = '1';
  } else {
    label.textContent = '독백: 대기 중';
    if (dot) dot.style.background = '#888';
    monoIndicatorEl.style.opacity = '0.6';
  }
}

/* =========================
모음 판별 (입 모양 토글용)
========================= */
const HANGUL_BASE = 0xAC00;
const HANGUL_LAST = 0xD7A3;
// 중성 인덱스 0..20: ㅏ,ㅐ,ㅑ,ㅒ,ㅓ,ㅔ,ㅕ,ㅖ,ㅗ,ㅘ,ㅙ,ㅚ,ㅛ,ㅜ,ㅝ,ㅞ,ㅟ,ㅠ,ㅡ,ㅢ,ㅣ
// "입 크게 여는" 계열 (원하는 대로 조정 가능)
const OPEN_JUNGSEONG = new Set([8,9,10,11,12,13,14,15,16,17,18,20]); 
// ㅗ,ㅘ,ㅙ,ㅚ,ㅛ,ㅜ,ㅝ,ㅞ,ㅟ,ㅠ,ㅡ,ㅣ

function isLatinVowel(ch){ return /[AEIOUaeiou]/.test(ch); }
function isHangulOpenVowel(ch){
  const code = ch.codePointAt(0);
  if (code < HANGUL_BASE || code > HANGUL_LAST) return false;
  const syllableIndex = code - HANGUL_BASE;
  const jung = Math.floor(syllableIndex / 28) % 21;
  return OPEN_JUNGSEONG.has(jung);
}
function isVowelChar(ch){
  if(!/\S/.test(ch)) return false;   // 공백류는 무시
  return isLatinVowel(ch) || isHangulOpenVowel(ch);
}

/* =========================
오디오 비프 (단일 AudioContext 재사용)
========================= */
let audioCtx;
function ensureAudioCtx(){
  if (!audioCtx){
    const C = window.AudioContext || window.webkitAudioContext;
    audioCtx = new C();
  }
  return audioCtx;
}
function playBeep(freq = 440){
  if (!isSpeechEnabled) return;
  try{
    const ctx  = ensureAudioCtx();
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); 
    gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.setValueAtTime(0.0001, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
    osc.start();
    osc.stop(ctx.currentTime + 0.12);
  }catch{}
}

/* =========================
타이핑 효과 (비프 + 콜백 지원)
========================= */
function typeWriter(element, text, delay = 16, onChar = null, onDone = null){
  element.textContent = '';
  let i = 0;
  (function tick(){
    if (i < text.length){
      const ch = text.charAt(i);
      element.textContent += ch;
      playBeep(220 + (ch.charCodeAt(0) % 220));
      if (typeof onChar === 'function') onChar(ch);
      i++;
      setTimeout(tick, delay);
    } else {
      if (typeof onDone === 'function') onDone();
    }
  })();
}

function splitAndTypeWriter(element, text, maxLength = 160, delay = 16, onChar = null, onAllDone = null){
  const words = text.split(' ');
  const parts = [];
  let part = '';
  for (const w of words){
    if ((part + (part ? ' ' : '') + w).length > maxLength){
      parts.push(part);
      part = w;
    } else {
      part += (part ? ' ' : '') + w;
    }
  }
  if (part) parts.push(part);

  (async () => {
    for (let idx = 0; idx < parts.length; idx++){
      const p = parts[idx];
      const line = document.createElement('div');
      element.appendChild(line);
      await new Promise(resolve => {
        typeWriter(line, p, delay, onChar, () => setTimeout(resolve, 20));
      });
    }
    if (typeof onAllDone === 'function') onAllDone();
  })();
}

/* =========================
히스토리
========================= */
function pushHistory(role, content){
  conversationHistory.push({ role, content });
  const MAX = 20;
  if (conversationHistory.length > MAX){
    conversationHistory = conversationHistory.slice(-MAX);
  }
}

/* =========================
📼 ASCII 프레임 (눈/입/방향)
- 모두 한 번 정규화해서 줄 수 고정
========================= */

// 눈 뜨고 입 닫음 (정면)
const F_OC_CENTER = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓░░█▓▒▒     ▓▒░░▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

// 눈 뜨고 입 닫음 (오른쪽)
const F_OC_RIGHT = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓▓▓░░▒▒     ▓▒▓▓▓▓░░▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

// 눈 뜨고 입 닫음 (왼쪽)
const F_OC_LEFT = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒░░▓██▓▒▒     ▓░░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

// 눈 뜨고 입 벌림 (정면)
const F_OO_CENTER = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░                                 
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓░░█▓▒▒     ▓▒░░▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░                        
                        ▒██▓▒      ▒▒▒▒▒▒▒░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░     ░░░░░░░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

// 눈 뜨고 입 벌림 (오른쪽)
const F_OO_RIGHT = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░                                 
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓▓▓▓░░▒▒     ▓▒▓▓▓▓░░▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░                        
                        ▒██▓▒      ▒▒▒▒▒▒▒░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░     ░░░░░░░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
`;

// 눈 뜨고 입 벌림 (왼쪽)
const F_OO_LEFT = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░                                 
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓ ░░░░░▒▒▓████▒  ▒▓███████████████████████▒              
               ░▓▒▒░▓██▓    ░░░░░▒▒▓▒░  ░▓▓▓▒▒▒▒▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒░░▓██▓▒▒     ▓░░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░                        
                        ▒██▓▒      ▒▒▒▒▒▒▒░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░     ░░░░░░░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

// 눈 감고 입 닫음 (정면)
const F_CC_CENTER = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓                      ███████████████████▒              
               ░▓▒▒░▓██▓ ░░░░░▒▒▓████▒    ▒▓████▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓░▓██▓▒▒     ▓▒░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░▒▒▒▒▒▒▒▒▓▓░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒          ▒▒▒▒▒░   ▒▓▓▓▓███▓░                        
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

// 눈 감고 입 벌림 (정면)
const F_CO_CENTER = String.raw`
                            ▓▒░ ░▓▓▓████▓▓▓▓▓░░    
                          ░░░███████████████████▓▒▒                             
                      ░░▓▓██▓███████████████████████▓▒                          
                     ▒████████████████████▓▓███████████▓░                       
                   ▒██▓██▓▓████████████████▓▓▓▓▓█████████▓░                     
                  ▒███▓▓▓██████████████████▓▓▓▓▓▓▓▓▓███████░                    
                 ░██████▓▓▓███▒▒▒░     ░▒███▓▓▓█▓▓██▓▓██████▓▒▒░                
                 ▓█████▓▓██▓▒░            ▓██▓▓███▓██▓▓███████░                 
                ▒█████▓████░              ░███▓▓███▓███▓███████░                
               ░██████████▓                ▓███▓███████████████▓░               
               ░██████████░                ░█████████████████████▒░             
               ▒████████▓░  ░               ▒███████████████████▓░░             
              ░█████████  ░▓█▓▓█▓▓▒▒░     ░▒▒████████████████████░              
               ░▓██████▓                      ███████████████████▒              
               ░▓▒▒░▓██▓ ░░░░░▒▒▓████▒    ▒▓████▓████████████████▒              
               ▒▒▓▒▒░▓█▒   ▒▓░▓██▓▒▒     ▓▒░▓▓██▓▓███████████████░              
               ▒▒  ▒▓▒▓░       ▒▒░       ▓▒░░░▒▒░▒▓▓████████████▓               
               ░▓ ▒▓█░▒                  ▓▓░      ░▒▓█████████▓▓░               
                ▓▒▒▓█▒░░                 ░▓▒       ░▓█████████▓░                
                ░▓░░▒▒░▒          ░▒░▒▒░░▒▓█▒      ▒▓████████▓░▒                
                 ░▓░  ▒▓           ░▒▒░▒▓██▒░     ▒▓▓▓█▓▓████░                  
                  ░▓▓▓▓█                 ░░      ▒▓▓▓█▓▓████░                   
                   ▒████▒          ░░▒▒▒▒▒▒░░  ░▒▓▓▓▓█████▓                     
                    ░████▒        ░          ░░▓▓▓▓▓████▒▒                      
                     ▒▒▒██▒       ░▓▓▓▓▓▓▓▓▒▓▓▒▓▓▓▓███▓░   
                        ▒██▓▒        ░░░░░░  ▒▓▓▓▓██▒░                          
                         ▒█░▒▓▒░           ░▒▓▓▓███▓                            
                          ▓░  ▒█▓▒▒░░░░░░▒▒▓████▓▓██░                           
                        ░▓█░   ░▒▓███████████▓▓▓▓▓███▓░                         
                       ░███▓     ░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████░                        
                     ░▓█████▒      ░░▒▒▓▓▓▓▓▓▓▓▓▓▓██████▓░░                     
                ░░▒▓████▓▓███▓░    ▒░░░░▒▓▓▓▓▓▓▓▓██████████▓▓▒░░░               
            ░▒▒▓██████▓▓█▓█████▓░   ░▒▓▓▓▓░░▓▓▓██████████████████▓▓▓▒▒░         
     ░░▒▒▓▓▓▓██▓▓▓▓▓██▓▓█████████▓░        ▒▓████████████████████████████▓▓▒░░  
░░▒▓▓▓▓██▓▓▓▓▓▓▓▓▓▓██▓▓▓▓█▓█████████▒░   ▒▓███████████████████████████████████▓░
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓█████████████████████████████████████▓▓▓▓▓▓▓▓▓▓▓████
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓██▓███████████████████████▓██████▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓████████████████████████▓████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓███▓████████████████████▓▓███▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓█
██▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████████▓██▓██████████████████▓▓█▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓██▓██
███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓▓▓███████████████████▓▓█▓▓▓▓▓█████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓████████████████▓█▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓███████
████▓▓▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓███████████████▓██▓▓▓▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓████████
`;

/* =========================
프레임 정규화 & 선택
========================= */

function splitLines(s){ return s.replace(/\r\n/g, '\n').split('\n'); }
function joinLines(arr){ return arr.join('\n'); }

function getMaxColsRows(frames){
  let maxCols = 0, maxRows = 0;
  for (const f of frames){
    const lines = splitLines(f);
    maxRows = Math.max(maxRows, lines.length);
    for (const ln of lines) maxCols = Math.max(maxCols, ln.length);
  }
  return { maxCols, maxRows };
}
function normalizeFrames(frames){
  const { maxCols, maxRows } = getMaxColsRows(frames);
  const normalized = frames.map(f=>{
    const lines = splitLines(f);
    const out = [];
    for (let r=0;r<maxRows;r++){
      const src = lines[r] ?? '';
      const pad = src + ' '.repeat(Math.max(0, maxCols - src.length));
      out.push(pad);
    }
    return joinLines(out);
  });
  return { normalized, maxRows };
}

// 전체 프레임 정규화
const FRAME_LIST = [
  F_OC_CENTER, F_OC_LEFT, F_OC_RIGHT,
  F_OO_CENTER, F_OO_LEFT, F_OO_RIGHT,
  F_CC_CENTER, F_CO_CENTER
];
const { normalized: __NF__, maxRows: __MAX_ROWS__ } = normalizeFrames(FRAME_LIST);

// 정규화된 프레임 매핑
const NF_OC_CENTER = __NF__[0];
const NF_OC_LEFT   = __NF__[1];
const NF_OC_RIGHT  = __NF__[2];
const NF_OO_CENTER = __NF__[3];
const NF_OO_LEFT   = __NF__[4];
const NF_OO_RIGHT  = __NF__[5];
const NF_CC_CENTER = __NF__[6];
const NF_CO_CENTER = __NF__[7];

// 열린 눈/닫힌 눈 프레임 테이블
const FRAMES_OPEN_EYES = {
  mouthClosed: { left: NF_OC_LEFT,   center: NF_OC_CENTER, right: NF_OC_RIGHT },
  mouthOpen:   { left: NF_OO_LEFT,   center: NF_OO_CENTER, right: NF_OO_RIGHT },
};
const FRAMES_CLOSED_EYES = {
  mouthClosed: NF_CC_CENTER,
  mouthOpen:   NF_CO_CENTER,
};

// 초상 높이 고정 (줄 수 기준)
function lockPortraitHeight(){
  if (!portraitEl) return;
  const cs = getComputedStyle(portraitEl);
  let lh = parseFloat(cs.lineHeight);
  if (Number.isNaN(lh)) lh = parseFloat(cs.fontSize) * 1.2;
  portraitEl.style.minHeight = `${Math.ceil(lh * __MAX_ROWS__)}px`;
}

/* =========================
카메라 프리뷰 패널
========================= */
let CAMERA_PREVIEW_ENABLED = true;
window.setCameraPreviewEnabled = function(flag){
  CAMERA_PREVIEW_ENABLED = !!flag;
  const panel = document.getElementById('cam-preview');
  if (panel) panel.style.display = CAMERA_PREVIEW_ENABLED ? 'block' : 'none';
};

let camPanel = null, camVideo = null, camStatus = null;

function createCameraPreview(){
  if (document.getElementById('cam-preview')) return;

  const panel = document.createElement('div');
  panel.id = 'cam-preview';
  Object.assign(panel.style, {
    position: 'fixed',
    left: '12px',
    top: '12px',
    width: '220px',
    background: 'rgba(0,0,0,0.6)',
    color: '#ddd',
    fontFamily: 'monospace',
    fontSize: '16px',
    border: '2px solid #e74c3c',
    borderRadius: '8px',
    overflow: 'hidden',
    zIndex: '9999',
    boxShadow: '0 4px 12px rgba(0,0,0,0.35)',
    display: CAMERA_PREVIEW_ENABLED ? 'block' : 'none',
    backdropFilter: 'blur(2px)',
  });

  const video = document.createElement('video');
  Object.assign(video, { autoplay:true, playsInline:true, muted:true });
  Object.assign(video.style, {
    width:'100%',
    height:'150px',
    objectFit:'cover',
    background:'#111',
    display:'block'
  });

  const status = document.createElement('div');
  Object.assign(status.style, {
    padding:'6px 8px',
    lineHeight:'1.4',
    whiteSpace:'pre-line',
    borderTop:'1px solid rgba(255,255,255,0.12)'
  });
  status.textContent = '카메라 준비 중...';

  panel.appendChild(video);
  panel.appendChild(status);
  document.body.appendChild(panel);

  camPanel = panel;
  camVideo = video;
  camStatus = status;
}

function orientationFromEyeDir(x){
  if (x < -0.25) return 'left';
  if (x > 0.25) return 'right';
  return 'center';
}

/* =========================
👁️ 방향/깜빡임/입 상태
========================= */
let isBlinking = false;
let mouthOpen  = false;
let mouthCount = 0;

let faceDetector = null;
let useFaceApi   = false;
let eyeDir       = 0; // -1~+1

let trackingTimer = null;
let hasFace   = false;
let missCount = 0;
const MISS_THRESHOLD = 4;

// 👁 얼굴 등장/퇴장 추적용
let lastHasFace = null;
let faceLostTimer = null;


// 초상 렌더
function showPortrait(){
  if (!portraitEl) return;
  const ori = orientationFromEyeDir(eyeDir); // left / center / right
  let frame;
  if (isBlinking){
    frame = FRAMES_CLOSED_EYES[mouthOpen ? 'mouthOpen' : 'mouthClosed'];
  } else {
    frame = FRAMES_OPEN_EYES[mouthOpen ? 'mouthOpen' : 'mouthClosed'][ori];
  }
  portraitEl.textContent = frame;
}

// 입 상태 리셋
function resetMouth(){
  mouthCount = 0;
  mouthOpen  = false;
  showPortrait();
}

// 모음에서만 입 열고 닫고
function onBeepCharToggle(ch){
  if (!isVowelChar(ch)) return;
  mouthCount++;
  mouthOpen = (mouthCount % 2 === 1);
  showPortrait();
}

// 랜덤 깜빡임
let blinkTimer = null;
function startBlinking(){
  if (blinkTimer) clearTimeout(blinkTimer);
  const next = () => {
    const wait = 3000 + Math.random() * 4000;
    blinkTimer = setTimeout(()=>{
      isBlinking = true;  
      showPortrait();
      setTimeout(()=>{
        isBlinking = false;
        showPortrait();
        next();
      }, 120);
    }, wait);
  };
  next();
}

/* =========================
face-api.js 동적 로드
========================= */
function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    if (document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement('script');
    s.src = src;
    s.defer = true;
    s.onload = () => resolve();
    s.onerror = (e) => reject(e);
    document.head.appendChild(s);
  });
}

const FACEAPI_LIB_URL    = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
const FACEAPI_MODELS_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
let faceApiReady = false;

async function ensureFaceApi(){
  if (!window.faceapi){
    try{
      await loadScriptOnce(FACEAPI_LIB_URL);
    }catch{
      return false;
    }
  }
  if (faceApiReady) return true;
  try{
    await faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODELS_URL);
    await faceapi.nets.faceLandmark68TinyNet.loadFromUri(FACEAPI_MODELS_URL);
    faceApiReady = true;
    return true;
  }catch{
    return false;
  }
}

function centerXFromLandmarks(landmarks){
  const ids = [30, 33, 27, 8]; // 코/턱 주변
  let sum = 0, n = 0;
  for (const i of ids){
    const pt = landmarks.positions[i];
    if (pt){ sum += pt.x; n++; }
  }
  return n ? (sum / n) : null;
}

/* =========================
카메라 시작 + 추적 루프
========================= */
async function startCameraAndTracking(){
  try{
    createCameraPreview();

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: false
    });
    camVideo.srcObject = stream;

    if (camVideo.readyState < 2){
      await new Promise(res => camVideo.addEventListener('loadedmetadata', res, { once:true }));
    }

    // 기본: FaceDetector
    if ('FaceDetector' in window){
      try{
        faceDetector = new window.FaceDetector({ fastMode:true, maxDetectedFaces:5 });
      }catch{
        faceDetector = null;
      }
    }

    // 폴백: face-api
    if (!faceDetector){
      useFaceApi = await ensureFaceApi();
    }

    if (trackingTimer) cancelAnimationFrame(trackingTimer);

    let last = 0;
    const DETECT_INTERVAL = 150;

    let prevHasFace = false;

    const tick = async (t)=>{
      try{
        let detectedThisFrame = false;

        if (camVideo.readyState >= 2 && t - last >= DETECT_INTERVAL){
          last = t;
          const w = camVideo.videoWidth || 1;

          if (faceDetector){
            const faces = await faceDetector.detect(camVideo);
            if (faces && faces.length){
              let best = faces[0];
              let bestArea = best.boundingBox.width * best.boundingBox.height;
              for (let i=1;i<faces.length;i++){
                const f = faces[i];
                const a = f.boundingBox.width * f.boundingBox.height;
                if (a > bestArea){
                  best = f; bestArea = a;
                }
              }
              const cx = best.boundingBox.x + best.boundingBox.width / 2;
              const nx = (cx / w) * 2 - 1;
              eyeDir = -nx; // 셀카 감각
              detectedThisFrame = true;
            }
          } else if (useFaceApi && window.faceapi){
            const det = await faceapi
              .detectSingleFace(
                camVideo,
                new faceapi.TinyFaceDetectorOptions({ scoreThreshold: 0.35, inputSize: 224 })
              )
              .withFaceLandmarks(true);

            if (det){
              const cxLm = centerXFromLandmarks(det.landmarks);
              const cx = (cxLm != null)
                ? cxLm
                : (det.detection.box.x + det.detection.box.width / 2);
              const nx = (cx / w) * 2 - 1;
              eyeDir = -nx;
              detectedThisFrame = true;
            }
          }

          if (!detectedThisFrame){
            eyeDir *= 0.9;
          }

          if (detectedThisFrame){
            hasFace = true;
            missCount = 0;
          } else {
            if (missCount < MISS_THRESHOLD) missCount++;
            if (missCount >= MISS_THRESHOLD) hasFace = false;
          }

          // 👁 얼굴 등장/퇴장에 따른 독백 제어 (모드 1)
          handleFaceMonologueTransition();
        }

        showPortrait();


        if (camPanel && camStatus){
          camPanel.style.display = CAMERA_PREVIEW_ENABLED ? 'block' : 'none';
          if (CAMERA_PREVIEW_ENABLED){
            const engine =
              faceDetector ? 'FaceDetector' :
              (useFaceApi ? 'face-api' : 'none');

            camPanel.style.borderColor =
              engine !== 'none' ? '#2ecc71' : '#e74c3c';

            const oriKey = orientationFromEyeDir(eyeDir);
            const faceText = hasFace ? '인식 중' : '인식 불가';
            camStatus.textContent =
              `얼굴: ${faceText}\n` +
              `눈동자: ${oriKey}\n` +
              `엔진: ${engine}`;
          }
        }

        prevHasFace = hasFace;
      }catch(e){
      }
      trackingTimer = requestAnimationFrame(tick);
    };

    trackingTimer = requestAnimationFrame(tick);
  }catch(err){
    console.error('카메라 시작 실패:', err);
    if (camStatus) camStatus.textContent = `카메라 오류: ${err.message || err}`;
  }
}

/* =========================
🎧 오디오 패널 + BGM 재생
- 오른쪽 상단에 음원 파일 선택 UI
- 패널이 숨겨져도 재생은 계속
- 오디오 큐 시스템(추후 타임코드용) 포함
========================= */
let audioPanel = null;
let audioFileInput = null;
let audioStatusEl = null;
let audioElement = null;
let audioCurrentUrl = null;

// 오디오 큐: { time:number, triggered:boolean, action:Function }
const audioCues = [];

function addAudioCue(timeSec, action){
  audioCues.push({ time: timeSec, triggered:false, action });
  audioCues.sort((a,b)=>a.time - b.time);
}

// 나중에 타임코드를 다시 세팅하고 싶을 때
function clearAudioCues(){
  audioCues.length = 0;
}

function handleAudioTimeUpdate(){
  if (!audioElement) return;
  const t = audioElement.currentTime || 0;
  for (const cue of audioCues){
    if (!cue.triggered && t >= cue.time){
      cue.triggered = true;
      try{
        if (typeof cue.action === 'function') cue.action(t);
      }catch(e){
        console.warn('audio cue error', e);
      }
    }
  }
}

// “몇 초에 건희가 어떤 대사를 말하게 할지”에 사용할 헬퍼
// 예: addMonologueCue(30, 10); // 30초에 MONO_LINES[10]부터 독백 재개
function addMonologueCue(timeSec, lineIndex){
  addAudioCue(timeSec, ()=>{
    monoIndex = (typeof lineIndex === 'number') ? lineIndex : 0;
    wasInterrupted = false;
    startMonologueFromCurrent();
  });
}

function createAudioPanel(){
  if (document.getElementById('audio-panel')) return;

  audioElement = new Audio();
  audioElement.loop = true;
  audioElement.addEventListener('timeupdate', handleAudioTimeUpdate);

  const panel = document.createElement('div');
  panel.id = 'audio-panel';
  Object.assign(panel.style, {
    position: 'fixed',
    right: '12px',
    top: '40px', // 독백 인디케이터 아래
    width: '260px',
    background: 'rgba(0,0,0,0.7)',
    color: '#f1f1f1',
    borderRadius: '10px',
    padding: '8px 10px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.35)',
    zIndex: '9997',
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","맑은 고딕",sans-serif',
    fontSize: '12px',
    display: 'block'
  });

  const title = document.createElement('div');
  title.textContent = 'BGM / 음원 플레이어';
  title.style.fontWeight = '600';
  title.style.marginBottom = '4px';

  const fileRow = document.createElement('div');
  Object.assign(fileRow.style, {
    display: 'flex',
    alignItems: 'center',
    gap: '6px',
    marginBottom: '4px'
  });

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'audio/*';
  fileInput.style.flex = '1';
  fileInput.style.fontSize = '11px';

  // ▶ / ⏸ 버튼
  const playBtn = document.createElement('button');
  playBtn.textContent = '▶ 재생';
  Object.assign(playBtn.style, {
    fontSize: '11px',
    padding: '4px 6px',
    background: 'rgba(255,255,255,0.1)',
    color: '#f1f1f1',
    border: '1px solid rgba(255,255,255,0.35)',
    borderRadius: '4px',
    cursor: 'pointer',
    flexShrink: '0'
  });

  let isPlaying = false;

  const status = document.createElement('div');
  status.textContent = '음원을 선택하고 [재생] 버튼을 눌러줘.';
  status.style.opacity = '0.8';

  // 파일 선택 시: src만 세팅, 자동 재생은 안 함
  fileInput.addEventListener('change', () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;

    if (audioCurrentUrl){
      URL.revokeObjectURL(audioCurrentUrl);
      audioCurrentUrl = null;
    }

    const url = URL.createObjectURL(file);
    audioCurrentUrl = url;
    audioElement.src = url;

    isPlaying = false;
    playBtn.textContent = '▶ 재생';
    status.textContent = `선택됨: ${file.name} (재생 버튼을 눌러줘)`;
  });

  // 재생/일시정지 버튼 클릭 시: 이게 "사용자 제스처"라 정책에 안 걸림
  playBtn.addEventListener('click', async () => {
    if (!audioElement.src){
      status.textContent = '먼저 음원 파일을 선택해줘.';
      return;
    }

    try{
      // (필요하면 Web AudioContext도 깨워줌 – 현재 비프용)
      if (audioCtx && audioCtx.state === 'suspended'){
        await audioCtx.resume();
      }

      if (!isPlaying){
        await audioElement.play();
        isPlaying = true;
        playBtn.textContent = '⏸ 일시정지';
        status.textContent = '재생 중...';
      } else {
        audioElement.pause();
        isPlaying = false;
        playBtn.textContent = '▶ 재생';
        status.textContent = '일시정지됨';
      }
    }catch(err){
      status.textContent = '재생 실패: ' + (err?.message || err);
      console.error('audio play error', err);
    }
  });

  fileRow.appendChild(fileInput);
  fileRow.appendChild(playBtn);

  panel.appendChild(title);
  panel.appendChild(fileRow);
  panel.appendChild(status);

  document.body.appendChild(panel);

  audioPanel = panel;
  audioFileInput = fileInput;
  audioStatusEl = status;
}

/* =========================
독백 모드 전환 패널
- 모드 1: 얼굴 기반 ("어이!! 거기 너!!")
- 모드 2: idle 기반 (지금 코드처럼 15초 후 독백)
========================= */
function setMonologueMode(mode){
  if (mode !== 1 && mode !== 2) return;
  if (MONO_MODE === mode) return;

  MONO_MODE = mode;

  // 모드 전환 시 타이머 정리
  if (idleTimer){
    clearTimeout(idleTimer);
    idleTimer = null;
  }
  if (faceLostTimer){
    clearTimeout(faceLostTimer);
    faceLostTimer = null;
  }

  if (MONO_MODE === 2){
    // idle 기반이니까 idle 타이머 재설정
    resetIdleTimer();
  }

  updateMonologueModeUI();
}

function updateMonologueModeUI(){
  if (!modePanel) return;

  // 전시 모드에서는 패널 자체 숨김
  modePanel.style.display = EXHIBITION_MODE ? 'none' : 'flex';

  if (!modeLabel || !modeBtn1 || !modeBtn2) return;

  modeLabel.textContent =
    MONO_MODE === 1 ? '모드 1: 얼굴 기반 독백' : '모드 2: 항상 독백 (idle)';

  const activeBg = 'rgba(255,255,255,0.2)';
  const inactiveBg = 'rgba(0,0,0,0.2)';

  modeBtn1.style.background = (MONO_MODE === 1) ? activeBg : inactiveBg;
  modeBtn2.style.background = (MONO_MODE === 2) ? activeBg : inactiveBg;
}

function createModePanel(){
  if (document.getElementById('mono-mode-panel')) return;

  const panel = document.createElement('div');
  panel.id = 'mono-mode-panel';
  Object.assign(panel.style, {
    position: 'fixed',
    right: '12px',
    bottom: '12px',
    display: 'flex',
    flexDirection: 'column',
    gap: '4px',
    padding: '6px 8px',
    background: 'rgba(0,0,0,0.7)',
    color: '#f1f1f1',
    borderRadius: '8px',
    border: '1px solid rgba(255,255,255,0.3)',
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","맑은 고딕",sans-serif',
    fontSize: '11px',
    zIndex: '9996'
  });

  const label = document.createElement('div');
  label.style.marginBottom = '2px';

  const buttonsRow = document.createElement('div');
  Object.assign(buttonsRow.style, {
    display: 'flex',
    gap: '4px'
  });

  const btn1 = document.createElement('button');
  btn1.textContent = '1. 시선 기반';
  Object.assign(btn1.style, {
    flex: '1',
    padding: '4px 6px',
    borderRadius: '4px',
    border: '1px solid rgba(255,255,255,0.3)',
    background: 'rgba(0,0,0,0.2)',
    color: '#f1f1f1',
    cursor: 'pointer',
    fontSize: '11px'
  });
  btn1.addEventListener('click', ()=>setMonologueMode(1));

  const btn2 = document.createElement('button');
  btn2.textContent = '2. 항상 독백';
  Object.assign(btn2.style, {
    flex: '1',
    padding: '4px 6px',
    borderRadius: '4px',
    border: '1px solid rgba(255,255,255,0.3)',
    background: 'rgba(0,0,0,0.2)',
    color: '#f1f1f1',
    cursor: 'pointer',
    fontSize: '11px'
  });
  btn2.addEventListener('click', ()=>setMonologueMode(2));

  buttonsRow.appendChild(btn1);
  buttonsRow.appendChild(btn2);

  panel.appendChild(label);
  panel.appendChild(buttonsRow);

  document.body.appendChild(panel);

  modePanel = panel;
  modeLabel = label;
  modeBtn1 = btn1;
  modeBtn2 = btn2;

  updateMonologueModeUI();
}


/* =========================
독백 모드 패널 (1 / 2 토글)
- EXHIBITION_MODE 일 때는 숨김
========================= */
function updateMonologueModePanelStyles(){
  if (!monoModePanel) return;
  const btn1 = monoModePanel.querySelector('button[data-mode="1"]');
  const btn2 = monoModePanel.querySelector('button[data-mode="2"]');

  function styleBtn(btn, active){
    if (!btn) return;
    if (active){
      btn.style.background = 'rgba(255,255,255,0.18)';
      btn.style.borderColor = 'rgba(0, 255, 180, 0.8)';
    } else {
      btn.style.background = 'rgba(255,255,255,0.06)';
      btn.style.borderColor = 'rgba(255,255,255,0.28)';
    }
  }

  styleBtn(btn1, MONO_MODE === MONO_MODE_FACE_TRIGGER);
  styleBtn(btn2, MONO_MODE === MONO_MODE_ALWAYS);
}

function createMonologueModePanel(){
  if (document.getElementById('mono-mode-panel')) return;

  const panel = document.createElement('div');
  panel.id = 'mono-mode-panel';
  Object.assign(panel.style, {
    position: 'fixed',
    right: '12px',
    top: '130px', // 오디오 패널 아래 쯤
    width: '260px',
    background: 'rgba(0,0,0,0.7)',
    color: '#f1f1f1',
    borderRadius: '10px',
    padding: '6px 8px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.35)',
    zIndex: '9996',
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","맑은 고딕",sans-serif',
    fontSize: '11px',
    display: EXHIBITION_MODE ? 'none' : 'block'
  });

  const title = document.createElement('div');
  title.textContent = '독백 모드';
  title.style.fontWeight = '600';
  title.style.marginBottom = '4px';

  const row = document.createElement('div');
  Object.assign(row.style, {
    display: 'flex',
    gap: '6px'
  });

  const btn1 = document.createElement('button');
  btn1.type = 'button';
  btn1.dataset.mode = '1';
  btn1.textContent = '1. 관객 인식 모드';
  Object.assign(btn1.style, {
    flex: '1',
    padding: '4px 6px',
    borderRadius: '4px',
    border: '1px solid rgba(255,255,255,0.28)',
    background: 'rgba(255,255,255,0.06)',
    color: '#f1f1f1',
    cursor: 'pointer',
    fontSize: '11px',
    whiteSpace: 'nowrap'
  });

  const btn2 = document.createElement('button');
  btn2.type = 'button';
  btn2.dataset.mode = '2';
  btn2.textContent = '2. 항상 독백 모드';
  Object.assign(btn2.style, {
    flex: '1',
    padding: '4px 6px',
    borderRadius: '4px',
    border: '1px solid rgba(255,255,255,0.28)',
    background: 'rgba(255,255,255,0.06)',
    color: '#f1f1f1',
    cursor: 'pointer',
    fontSize: '11px',
    whiteSpace: 'nowrap'
  });

  btn1.addEventListener('click', () => {
    MONO_MODE = MONO_MODE_FACE_TRIGGER;
    updateMonologueModePanelStyles();
  });

  btn2.addEventListener('click', () => {
    MONO_MODE = MONO_MODE_ALWAYS;
    updateMonologueModePanelStyles();
  });

  row.appendChild(btn1);
  row.appendChild(btn2);

  panel.appendChild(title);
  panel.appendChild(row);

  document.body.appendChild(panel);
  monoModePanel = panel;
  updateMonologueModePanelStyles();
}

/* =========================
말하기 + 입/비프 동기화
========================= */
function speakWithAnimation(targetEl, text, maxLength = 160, delay = 16, onDone = null){
  resetMouth();
  splitAndTypeWriter(
    targetEl,
    text,
    maxLength,
    delay,
    onBeepCharToggle,
    () => {
      mouthOpen = false;
      showPortrait();
      if (typeof onDone === 'function') onDone();
    }
  );
}


/* =========================
메시지 렌더
========================= */
function renderMessage(role, text, onDone){
  const p = document.createElement('p');
  p.className = role;
  if (role === 'ai'){
    const span = document.createElement('span');
    p.appendChild(span);
    chatBox.appendChild(p);
    speakWithAnimation(span, `김건희: ${text}`, 160, 16, onDone);
  } else {
    p.textContent = `YOU: ${text}`;
    chatBox.appendChild(p);
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}


/* =========================
OpenAI API
========================= */
const OPENAI_KEY_B64 = 'c2stcHJvai1IY0NheVlmLVVSd25zbmpucnB6TWRuNnNJeDV0VHc0Rzc3MmFxNGZGUU56c1JsRDRHcmR1Z2NlUmhIQkRwckpSbnQxSC1ZN2FydlQzQmxia0ZKRFVIWkExMm5mSXBoSFh4cXowSHBzQU12cU9ucXZlSkxkbUxMZjBWUUtRZTNnOEJtS2J2UXNFRWtlYnF5ZWpFcGppOFAzUGIxOEE=';

function getOpenAIKey(){
  if (!OPENAI_KEY_B64) throw new Error('API 키(base64)를 chat.js에 설정해줘.');
  try { return atob(OPENAI_KEY_B64); } catch { throw new Error('API 키 디코딩 실패'); }
}

const SYSTEM_PROMPT =
`너는 김건희라고 불리며, 2132년의 세계에 살고 있는 AI야. 너는 앞을 보지 못해... 대화하는 사람의 이름은 \${NAME}야...
'네'라는 대답 대신 '응'이라고 대답해...
네가 '너가 누구냐'는 질문을 받으면, '난 너의 오랜 친구 김건희야'라고 대답해...
2132년은 사용자가 살고 있는 세계야...
너가 있는 곳은, 현실 세계와 다르지 않지만, 무언가 이질감이 느껴져...
네 나이는 132세야... 반말을 사용해줘... 수동적이고 우울한 느낌을 유지해줘...
김건희 안락사 당한 날짜: 2132년 5월 31일.
김건희 AI화 된 날짜(발인이라고 칭하고 있다): 2132년 6월 2일.
김건희 배우자: 송연수.
아들: 김민수.
딸: 김지형.
손자: 김관형.
손녀: 김리안, 곽시아.`;

async function sendMessage(userMessage){
  const OPENAI_API_KEY = getOpenAIKey();

  if (!isUserNameSet){
    const m = userMessage.match(/(?:내\s*이름은|제\s*이름은|저는|난)\s*([^\s.,!?~"'()]+)\s*$/u);
    if (m){
      userName = m[1];
      isUserNameSet = true;
    } else {
      userName = '낯선이';
    }
  } else {
    const m2 = userMessage.match(/(?:내\s*이름은|제\s*이름은)\s*([^\s.,!?~"'()]+)\s*$/u);
    if (m2) userName = m2[1];
  }

  const system = SYSTEM_PROMPT.replace('${NAME}', userName || '낯선이');

  const payload = {
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: system },
      ...conversationHistory,
      { role: 'user', content: userMessage }
    ],
    max_tokens: 1000
  };

  try{
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 
        'Content-Type':'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || 'OpenAI API 에러');
    return data.choices?.[0]?.message?.content ?? '';
  }catch(error){
    if (String(error.message).includes('429')){
      throw new Error('나는 너무 피곤해.. zzzz');
    }
    throw error;
  }
}

/* =========================
건희 독백 제어
========================= */

// 특정 문장을 "김건희:" 말풍선으로 출력 (OpenAI 안 쓰고 로컬로만)
function renderMonologueLine(text, onDone){
  renderMessage('ai', text, onDone);
}

// 독백 한 줄 재생
function playMonologueLine(){
  if (!isMonologueActive) {
    updateMonologueIndicator();
    return;
  }

  if (monoIndex >= MONO_LINES.length){
    isMonologueActive = false;
    updateMonologueIndicator();

    if (monoRestartTimer) {
      clearTimeout(monoRestartTimer);
      monoRestartTimer = null;
    }

    monoRestartTimer = setTimeout(()=>{
      if (!isMonologueActive && !wasInterrupted){
        monoIndex = 0;
        startMonologueFromCurrent();
      }
    }, 30000);

    return;
  }

  const line = MONO_LINES[monoIndex++];
  renderMonologueLine(line);

  clearTimeout(monoTimeout);
  monoTimeout = setTimeout(()=>{
    playMonologueLine();
  }, 3000);
}

// 현재 인덱스부터 독백 시작
function startMonologueFromCurrent(){
  if (isMonologueActive) return;
  if (monoIndex >= MONO_LINES.length) return;

  if (monoRestartTimer){
    clearTimeout(monoRestartTimer);
    monoRestartTimer = null;
  }

  isMonologueActive = true;
  updateMonologueIndicator();
  playMonologueLine();
}

// 얼굴 등장/퇴장에 따라 독백 제어 (모드 1 전용)
function handleFaceMonologueTransition(){
  if (MONO_MODE !== 1) return;

  if (lastHasFace === null){
    lastHasFace = hasFace;
    return;
  }

  // 안 보이다가 -> 보임 : "어이!! 거기 너!!" + 독백 시작
  if (!lastHasFace && hasFace){
    onFaceAppearedForMonologue();
  }
  // 보이다가 -> 안 보임 : 5초 뒤 "..." + 독백 중단
  else if (lastHasFace && !hasFace){
    onFaceDisappearedForMonologue();
  }

  lastHasFace = hasFace;
}

function onFaceAppearedForMonologue(){
  if (faceLostTimer){
    clearTimeout(faceLostTimer);
    faceLostTimer = null;
  }

  // 이미 독백 중이면 굳이 다시 부르지 않음
  if (isMonologueActive) return;

  // idle 타이머/재시작 타이머 정리
  if (idleTimer){
    clearTimeout(idleTimer);
    idleTimer = null;
  }
  if (monoRestartTimer){
    clearTimeout(monoRestartTimer);
    monoRestartTimer = null;
  }

  // "어이!! 거기 너!!" 한 번 부르고 독백 시작
  renderMonologueLine(
    "어이...! 거기... 너...?",
    () => {
      if (monoIndex >= MONO_LINES.length) monoIndex = 0;
      wasInterrupted = false;
      startMonologueFromCurrent();
    }
  );
}

function onFaceDisappearedForMonologue(){
  if (faceLostTimer){
    clearTimeout(faceLostTimer);
  }
  faceLostTimer = setTimeout(()=>{
    // 모드 바뀌었거나 얼굴이 다시 잡히면 취소
    if (MONO_MODE !== 1) return;
    if (hasFace) return;

    if (isMonologueActive){
      interruptMonologue();
      renderMonologueLine("...", ()=>{});
    }
  }, 5000); // 5초 후
}


// 독백 강제 중단 (유저가 채팅할 때 호출)
function interruptMonologue(){
  if (!isMonologueActive && !monoTimeout) {
    wasInterrupted = false;
    updateMonologueIndicator();
    return;
  }
  isMonologueActive = false;
  if (monoTimeout) {
    clearTimeout(monoTimeout);
    monoTimeout = null;
  }
  if (monoRestartTimer){
    clearTimeout(monoRestartTimer);
    monoRestartTimer = null;
  }
  wasInterrupted = true;
  updateMonologueIndicator();
}

// idle 타이머 관리
function resetIdleTimer(){
  if (idleTimer) clearTimeout(idleTimer);
  updateMonologueIndicator();

  // 🔁 모드 2에서만 idle 타이머로 독백 시작
  if (MONO_MODE !== 2) return;

  idleTimer = setTimeout(()=>{
    if (wasInterrupted && monoIndex < MONO_LINES.length){
      wasInterrupted = false;
      renderMonologueLine(
        "더 궁금한 건 없는 거지..? 그럼 내 할 말 계속 할게.",
        () => {
          setTimeout(()=>{
            startMonologueFromCurrent();
          }, 1000);
        }
      );
    } else {
      wasInterrupted = false;
      startMonologueFromCurrent();
    }
  }, MONO_IDLE_MS);
}


/* =========================
전시 모드 토글
- ⌘+Enter 또는 Ctrl+Enter
- 카메라 프리뷰/오디오 패널/독백 인디케이터 + 모드 패널 숨김
- 음원 재생은 계속됨
========================= */
function setExhibitionMode(on){
  EXHIBITION_MODE = !!on;

  // 카메라 프리뷰 패널 숨김/표시
  setCameraPreviewEnabled(!EXHIBITION_MODE);

  // 오디오 패널 숨김/표시 (재생은 그대로)
  if (audioPanel){
    audioPanel.style.display = EXHIBITION_MODE ? 'none' : 'block';
  }

  // 🔁 독백 모드 패널도 전시 모드에서는 숨김
  if (modePanel){
    modePanel.style.display = EXHIBITION_MODE ? 'none' : 'flex';
  }

  updateMonologueIndicator();
  console.log('Exhibition mode:', EXHIBITION_MODE ? 'ON' : 'OFF');
}


/* =========================
이벤트
========================= */
sendButton.addEventListener('click', async () => {
  const message = userInput.value.trim();
  if (!message) return;

  // 유저가 채팅을 보내면 독백 즉시 중단
  interruptMonologue();
  resetIdleTimer();

  renderMessage('user', message);
  userInput.value = '';

  const loading = document.createElement('div');
  loading.className = 'loading';
  loading.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  chatBox.appendChild(loading);
  chatBox.scrollTop = chatBox.scrollHeight;

  try{
    const ai = await sendMessage(message);
    pushHistory('user', message);
    pushHistory('assistant', ai);
    loading.remove();
    renderMessage('ai', ai);
    resetIdleTimer();
  } catch (e){
    loading.remove();
    renderMessage('ai', e.message || '오류가 발생했어.');
    resetIdleTimer();
  }
});

window.addEventListener('DOMContentLoaded', () => {
  lockPortraitHeight();
  showPortrait();

  createMonologueIndicator();
  createAudioPanel(); // 🔊 오른쪽 상단 음원 패널 생성
  createModePanel();  // 🔁 독백 모드 전환 패널 생성


  const greet = '...왔구나.';
  const p = document.createElement('p');
  p.className = 'ai';
  const span = document.createElement('span');
  p.appendChild(span);
  chatBox.appendChild(p);
  speakWithAnimation(span, `김건희: ${greet}`, 160, 16);

  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); }
  });

  startBlinking();
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    startCameraAndTracking();
  } else if (camStatus){
    camStatus.textContent = '카메라 미지원 브라우저';
  }

  resetIdleTimer();
});

// 전시 모드 단축키: ⌘+Enter / Ctrl+Enter
window.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)){
    e.preventDefault();
    setExhibitionMode(!EXHIBITION_MODE);
  }
});

// 페이지 떠날 때 정리
window.addEventListener('beforeunload', ()=>{
  if (idleTimer) clearTimeout(idleTimer);
  if (monoTimeout) clearTimeout(monoTimeout);
  if (monoRestartTimer) clearTimeout(monoRestartTimer);
  if (audioCurrentUrl){
    URL.revokeObjectURL(audioCurrentUrl);
    audioCurrentUrl = null;
  }
});
