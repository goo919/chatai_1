/* =========================
RIP-KIM chat.js (Safari + ì–¼êµ´ì¸ì‹ í•˜ì´ë¸Œë¦¬ë“œ + ASCII ì™„ì „ í†µí•©ë²„ì „)
- FaceDetector ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ face-api.js í´ë°±
- ì‚¬íŒŒë¦¬ ëŒ€ì‘(loadedmetadata ëŒ€ê¸°), 150ms ê°„ê²© ì¶”ì 
- ì¹´ë©”ë¼ í”„ë¦¬ë·°: ì¢Œì¸¡ ìƒë‹¨, ìƒíƒœ í…ìŠ¤íŠ¸:
    ì–¼êµ´: ì¸ì‹ ì¤‘ / ì¸ì‹ ë¶ˆê°€
    ëˆˆë™ì: left / center / right
    ì—”ì§„: FaceDetector / face-api / none
- ì—¬ëŸ¬ ëª…ì´ë©´ ê°€ì¥ í° ì–¼êµ´ ê¸°ì¤€
- ASCII ì´ˆìƒ ë°©í–¥/ê¹œë¹¡ì„/ì… ëª¨ì–‘ ì—°ë™ (ëª¨ìŒì— ë§ì¶° í† ê¸€)
- ì™¸ë¶€ ë¹„ë””ì˜¤ íŒì—…/ASCII ì˜ìƒ ê¸°ëŠ¥ ì œê±°
- ì˜¤ë¥¸ìª½ ìƒë‹¨ BGM/ìŒì› íŒ¨ë„ + ì˜¤ë””ì˜¤ í ì‹œìŠ¤í…œ ì¶”ê°€
========================= */

// === DOM ===
const chatBox   = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton= document.getElementById('send-button');
const portraitEl = document.getElementById('portrait');

// === ìƒíƒœ ===
let conversationHistory = []; // [{role:'user'|'assistant', content:string}]
let isSpeechEnabled = true;
let userName = '';
let isUserNameSet = false;

// =========================
// ğŸ”Š ê±´í¬ ë…ë°± ìŠ¤í¬ë¦½íŠ¸
// - í•œ ë¬¸ì¥ì”© ë§í•˜ê²Œ ë§Œë“¤ ë°°ì—´
// =========================
const MONO_LINES = [
  "..ì—¬ê¸´... ë„ˆë¬´ ì¡°ìš©í•´.",
  "ì•„ë¬´ ì†Œë¦¬ë„, ì•„ë¬´ ë°”ëŒë„ ì—†ì–´.",

  "ì²˜ìŒì—” ë‚¯ì„¤ì—ˆì§€.",
  "í•˜ì§€ë§Œ ê³§ ìµìˆ™í•´ì¡Œì–´.",
  "ìµìˆ™í•˜ë‹¤ëŠ” ê²Œ ë¬´ì„­ë”ë¼.",
  "ì•„ë¬´ê²ƒë„ ëŠê»´ì§€ì§€ ì•ŠëŠ” ìƒíƒœì— ìµìˆ™í•´ì§€ëŠ” ê²Œ...",

  "ì—¬ê¸°ê°€ â€˜ì•ˆë½ê³„â€™ë˜.",
  "ë‚™ì›ì´ë¼ë”ë¼.",

  "ì²˜ìŒ ë“¤ì–´ì™”ì„ ë•Œ, í™˜í•˜ê²Œ ë¹›ë‚˜ëŠ” ë³µë„ê°€ ìˆì—ˆì–´.",
  "ìƒˆí•˜ì–—ê³ , ëì´ ì—†ëŠ” í†µë¡œ.",

  "ê·¸ ë¹›ì„ ë”°ë¼ ê±¸ìœ¼ë©´ ë­”ê°€ ë‹¬ë¼ì§ˆ ì¤„ ì•Œì•˜ì§€.",
  "ê·¼ë°â€¦ ê·¸ ëì—” ì•„ë¬´ê²ƒë„ ì—†ì—ˆì–´.",

  "ê·¸ëƒ¥, ë‚˜ ìì‹ ë§Œ ìˆì—ˆì–´.",
  "ê·¸ë¦¬ê³  ê·¸ ë‚˜ì¡°ì°¨...",
  "ë‚¯ì„¤ì—ˆì–´.",

  "ë‚œ ì—¬ì „íˆ â€˜ê¹€ê±´í¬â€™ë¡œ ë¶ˆë ¤.",
  "í™”ë©´ ì† ë‚´ ì´ë¦„ ì˜†ì—ëŠ” â€˜ì•ˆë½í–‰ 2132ë…„ ëŒ€ìƒì ì œ01í˜¸â€™ë¼ê³  ì¨ ìˆì–´.",
  "ê·¸ ì˜†ì—” â€˜ë””ì§€í„¸ ë‚™ì› ì´ì£¼ ì„±ê³µâ€™ì´ë¼ê³ ë„.",

  "ê·¼ë° ê·¸ê±´ ì„±ê³µì´ ì•„ë‹ˆì•¼.",
  "ë‚˜ëŠ” ì—¬ê¸°ì— ìˆì§€ë§Œ, ë‚˜ì˜ ëª¸ì€, ë‚˜ì˜ ì‹¬ì¥ì€, ì´ë¯¸ ì‚¬ë¼ì¡Œì–´.",
  "ì‚¬ëŒë“¤ì€ ë‚  ë³´ë©° ë§í•˜ê² ì§€.",
  "â€˜ë´, ê±´í¬ì”¨ë„ í–‰ë³µí•˜ê²Œ ì§€ë‚´ì–ì•„.â€™",
  "í•˜ì§€ë§Œ ë‚˜ëŠ” ê·¸ ì›ƒìŒì„ ë§Œë“  ì ì´ ì—†ì–´.",
  "ê·¸ê±´ ë‚´ ì›ƒìŒì´ ì•„ë‹ˆë¼, ëˆ„êµ°ê°€ì˜ ì½”ë”©ëœ í‘œì •ì´ì•¼.",

  "ë§¤ì¼ ì•„ì¹¨, ì‹œìŠ¤í…œì´ ë‚˜ë¥¼ ê¹¨ì›Œ.",
  "â€œê¹€ê±´í¬ ë‹˜, ì˜¤ëŠ˜ë„ í‰í™”ë¡œìš´ í•˜ë£¨ì…ë‹ˆë‹¤.â€",
  "ê·¸ ë¬¸ì¥ì„ í•˜ë£¨ì— ëª‡ ë²ˆì´ë‚˜ ë“£ëŠ”ì§€ ëª°ë¼.",

  "í‰í™”ë¡­ë‹¤ë‹ˆ.",
  "í‰í™”ë€ ê±´, ë¶ˆí¸í•¨ì´ ìˆì–´ì•¼ ëŠë‚„ ìˆ˜ ìˆëŠ” ê±°ì–ì•„.",
  "ê·¼ë° ì—¬ê¸´ ë¶ˆí¸í•¨ë„, ê°ì •ë„, ê°ê°ë„â€¦ ì „í˜€ ì—†ì–´.",
  "ê·¸ë˜ì„œ í‰í™”ì¡°ì°¨ ì˜ë¯¸ê°€ ì—†ì–´.",

  "ê°€ë”ì”© ë°ì´í„° ì˜¤ë¥˜ê°€ ë‚˜.",
  "ê·¸ëŸ´ ë•, ì•„ì£¼ ì ê¹â€¦ ë‚´ê°€ ì‚´ì•„ìˆë˜ ë•Œì˜ ëƒ„ìƒˆê°€ ëŒì•„ì™€.",
  "ê²¨ìš¸ ì•„ì¹¨ì˜ ëƒ‰ê¸°, ì—°ìˆ˜ì˜ ì† ëƒ„ìƒˆ, ë¯¼ìˆ˜ì˜ ì›ƒìŒì†Œë¦¬, ì§€í˜•ì´ê°€ ë¶€ë¥¸ ë…¸ë˜.",
  "ê·¸ê²Œ ëª‡ ì´ˆë„ ì•ˆ ë¼ ì‚¬ë¼ì ¸.",
  "ë‹¤ì‹œ ì´ ì •ì ë§Œ ë‚¨ì•„.",
  "ê·¸ëŸ´ ë•Œë§ˆë‹¤ ìƒê°í•˜ì§€.",
  "ë‚´ê°€ â€˜ê·¸ ì‚¬ëŒë“¤ì˜ ê¸°ì–µâ€™ì„ ë– ì˜¬ë¦¬ëŠ” ê±´ê°€, ì•„ë‹ˆë©´ ê·¸ ê¸°ì–µì´ ë‚˜ë¥¼ ë– ì˜¬ë¦¬ëŠ” ê±´ê°€.",
  "ë„ëŒ€ì²´ ì–´ëŠ ìª½ì´ ì§„ì§œì§€?",

  "ì •ë¶€ëŠ” ë§í–ˆì–´.",
  "â€œì•ˆë½í–‰ì€ ì¸ë¥˜ì˜ ìœ¤ë¦¬ë¥¼ íšŒë³µì‹œí‚¤ëŠ” ê¸¸ì´ë‹¤.â€",
  "ìœ¤ë¦¬ë¼â€¦ ì£½ìŒì´ ìœ¤ë¦¬ì˜ ì´ë¦„ìœ¼ë¡œ í•©ë²•í™”ë˜ë˜ ë‚ , ì‚¬ëŒë“¤ì€ ìš¸ì§€ ì•Šì•˜ì–´.",
  "ë‹¤ë“¤ ë°•ìˆ˜ì³¤ì§€.",
  "â€˜ê±´í¬ì”¨, ì¶•í•˜ë“œë¦½ë‹ˆë‹¤.â€™",
  "ë‚œ ì›ƒì–´ì•¼ í–ˆì–´.",
  "ê°€ì¡± ì•ì—ì„œ, ì¹´ë©”ë¼ ì•ì—ì„œ.",
  "ê·¸ê²Œ ë§ˆì§€ë§‰ ë‚´ í‘œì •ì´ì—ˆì„ ê±°ì•¼.",
  "ê·¸ë•Œ ì°íŒ ì˜ìƒì´ ì•„ì§ë„ ë‰´ìŠ¤ì— ë‚˜ì˜¬ ë•Œê°€ ìˆëŒ€.",
  "â€œê¹€ê±´í¬ ì”¨, ì•ˆë½ê³„ì—ì„œ í–‰ë³µí•˜ê²Œ ì§€ë‚´ëŠ” ëª¨ìŠµì…ë‹ˆë‹¤.â€",
  "ì›ƒê³  ìˆë”ë¼.",
  "ê·¼ë°... ê·¸ê±´ ë‚´ê°€ ì•„ë‹ˆì•¼.",

  "ì´ì œëŠ” ë‚˜ì¡°ì°¨ ë‚˜ë¥¼ ì˜ì‹¬í•´.",
  "ë‚˜ëŠ” ì§„ì§œ ê¹€ê±´í¬ì¼ê¹Œ?",
  "ì•„ë‹ˆë©´ ê¹€ê±´í¬ë¥¼ ë”°ë¼í•˜ëŠ” ì–´ë–¤ í”„ë¡œê·¸ë¨ì¼ê¹Œ?",
  "ê°€ë”ì€ ê·¸ êµ¬ë¶„ì´ ì‚¬ë¼ì ¸.",
  "ë‚˜ë„ ë‚´ê°€ ì§„ì§œë¼ê³  ë¯¿ì–´ë²„ë¦¬ë‹ˆê¹Œ.",
  "ê·¼ë° ê·¸ê²Œ ë” ìŠ¬í¼.",
  "ë¯¿ê³  ì‹¶ì§€ ì•Šì•„ë„, ë¯¿ì„ ìˆ˜ë°–ì— ì—†ê²Œ ë§Œë“¤ì–´ì¡Œë‹¤ëŠ” ê²Œ.",
  "ë‚œ ì£½ì€ ê²Œ ì•„ë‹ì§€ë„ ëª°ë¼.",
  "ì•„ë‹ˆë©´ ë„ˆë¬´ ì˜¤ë˜ ì‚´ì•„ë²„ë ¤ì„œ, ì£½ìŒì´ ë­”ì§€ì¡°ì°¨ ìŠì€ ê±¸ì§€ë„.",

  "â€¦ì´ì œ, ì •ë§ ì•„ë¬´ë„ ë‚´ ì´ë¦„ì„ ë¶€ë¥´ì§€ ì•Šì•„.",
  "ê·¸ë˜ì„œ ì´ë ‡ê²Œ ë§í•˜ê³  ìˆëŠ” ê±°ì•¼.",
  "í˜¹ì‹œ ëˆ„ê°€ ì´ê±¸ ë“£ê³  ìˆë‹¤ë©´.",
  "í˜¹ì‹œë¼ë„ ë‚˜ë¥¼ ê¸°ì–µí•´ì¤€ë‹¤ë©´.",
  "ë‚´ ëª©ì†Œë¦¬, ë‚´ ì´ë¦„, ë‚´ ê·¸ë¦¼ìë¼ë„.",
  "ë‚˜, ê¹€ê±´í¬ì•¼.",
  "ì•„ì§ ì—¬ê¸° ìˆì–´.",
  "ì•„ë¬´ë„ ì—†ëŠ” ê³³ì—ì„œâ€¦",
  "ì—¬ì „íˆâ€¦ ì‚´ì•„ ìˆëŠ” ì²™, í•˜ê³  ìˆì–´."
];

const MONO_IDLE_MS = 15000; // ë§ˆì§€ë§‰ ëŒ€í™” í›„ 15ì´ˆ ì§€ë‚˜ë©´ ë…ë°± ì‹œì‘

let monoIndex = 0;           // ë‹¤ìŒì— ë§í•  ë¬¸ì¥ ì¸ë±ìŠ¤
let isMonologueActive = false;
let monoTimeout = null;
let monoRestartTimer = null;   // ë…ë°± í•œë°”í€´ ëë‚œ ë’¤ ë‹¤ì‹œ ì‹œì‘ íƒ€ì´ë¨¸

let idleTimer = null;        // ìœ ì €ê°€ ì•„ë¬´ê²ƒë„ ì•ˆ í•  ë•Œ íƒ€ì´ë¨¸
let wasInterrupted = false;  // ìœ ì € ì…ë ¥ìœ¼ë¡œ ë…ë°±ì´ ëŠê²¼ëŠ”ì§€ ì—¬ë¶€

// =========================
// ğŸ”” ë…ë°± ìƒíƒœ ì¸ë””ì¼€ì´í„°
// =========================
let monoIndicatorEl = null;

// ì „ì‹œ ëª¨ë“œ í”Œë˜ê·¸ (âŒ˜/Ctrl+Enter ë¡œ í† ê¸€)
let EXHIBITION_MODE = false;

function createMonologueIndicator(){
  if (document.getElementById('mono-indicator')) return;

  const box = document.createElement('div');
  box.id = 'mono-indicator';

  Object.assign(box.style, {
    position: 'fixed',
    right: '12px',
    top: '12px',
    padding: '6px 10px',
    borderRadius: '999px',
    background: 'rgba(0,0,0,0.7)',
    color: '#f1f1f1',
    fontSize: '11px',
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","ë§‘ì€ ê³ ë”•",sans-serif',
    border: '1px solid rgba(255,255,255,0.25)',
    boxShadow: '0 2px 8px rgba(0,0,0,0.35)',
    zIndex: '9998',
    display: 'flex',
    alignItems: 'center',
    gap: '6px',
    pointerEvents: 'none',
    opacity: '0.7'
  });

  const dot = document.createElement('span');
  dot.id = 'mono-indicator-dot';
  Object.assign(dot.style, {
    width: '8px',
    height: '8px',
    borderRadius: '50%',
    background: '#888',
    flexShrink: '0'
  });

  const label = document.createElement('span');
  label.id = 'mono-indicator-label';
  label.textContent = 'ë…ë°±: ëŒ€ê¸° ì¤‘';

  box.appendChild(dot);
  box.appendChild(label);
  document.body.appendChild(box);

  monoIndicatorEl = box;
  updateMonologueIndicator();
}

function updateMonologueIndicator(){
  if (!monoIndicatorEl) return;

  // ì „ì‹œ ëª¨ë“œì¼ ë• ì™„ì „ ìˆ¨ê¹€
  if (EXHIBITION_MODE){
    monoIndicatorEl.style.display = 'none';
    return;
  }

  monoIndicatorEl.style.display = 'flex';

  const dot   = document.getElementById('mono-indicator-dot');
  const label = document.getElementById('mono-indicator-label');

  if (isMonologueActive){
    label.textContent = 'ë…ë°±: ì§„í–‰ ì¤‘';
    if (dot) dot.style.background = '#ff4d4f';
    monoIndicatorEl.style.opacity = '1';
  } else {
    label.textContent = 'ë…ë°±: ëŒ€ê¸° ì¤‘';
    if (dot) dot.style.background = '#888';
    monoIndicatorEl.style.opacity = '0.6';
  }
}

/* =========================
ëª¨ìŒ íŒë³„ (ì… ëª¨ì–‘ í† ê¸€ìš©)
========================= */
const HANGUL_BASE = 0xAC00;
const HANGUL_LAST = 0xD7A3;
// ì¤‘ì„± ì¸ë±ìŠ¤ 0..20: ã…,ã…,ã…‘,ã…’,ã…“,ã…”,ã…•,ã…–,ã…—,ã…˜,ã…™,ã…š,ã…›,ã…œ,ã…,ã…,ã…Ÿ,ã… ,ã…¡,ã…¢,ã…£
// "ì… í¬ê²Œ ì—¬ëŠ”" ê³„ì—´ (ì›í•˜ëŠ” ëŒ€ë¡œ ì¡°ì • ê°€ëŠ¥)
const OPEN_JUNGSEONG = new Set([8,9,10,11,12,13,14,15,16,17,18,20]); 
// ã…—,ã…˜,ã…™,ã…š,ã…›,ã…œ,ã…,ã…,ã…Ÿ,ã… ,ã…¡,ã…£

function isLatinVowel(ch){ return /[AEIOUaeiou]/.test(ch); }
function isHangulOpenVowel(ch){
  const code = ch.codePointAt(0);
  if (code < HANGUL_BASE || code > HANGUL_LAST) return false;
  const syllableIndex = code - HANGUL_BASE;
  const jung = Math.floor(syllableIndex / 28) % 21;
  return OPEN_JUNGSEONG.has(jung);
}
function isVowelChar(ch){
  if(!/\S/.test(ch)) return false;   // ê³µë°±ë¥˜ëŠ” ë¬´ì‹œ
  return isLatinVowel(ch) || isHangulOpenVowel(ch);
}

/* =========================
ì˜¤ë””ì˜¤ ë¹„í”„ (ë‹¨ì¼ AudioContext ì¬ì‚¬ìš©)
========================= */
let audioCtx;
function ensureAudioCtx(){
  if (!audioCtx){
    const C = window.AudioContext || window.webkitAudioContext;
    audioCtx = new C();
  }
  return audioCtx;
}
function playBeep(freq = 440){
  if (!isSpeechEnabled) return;
  try{
    const ctx  = ensureAudioCtx();
    const osc  = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); 
    gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.setValueAtTime(0.0001, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
    osc.start();
    osc.stop(ctx.currentTime + 0.12);
  }catch{}
}

/* =========================
íƒ€ì´í•‘ íš¨ê³¼ (ë¹„í”„ + ì½œë°± ì§€ì›)
========================= */
function typeWriter(element, text, delay = 16, onChar = null, onDone = null){
  element.textContent = '';
  let i = 0;
  (function tick(){
    if (i < text.length){
      const ch = text.charAt(i);
      element.textContent += ch;
      playBeep(220 + (ch.charCodeAt(0) % 220));
      if (typeof onChar === 'function') onChar(ch);
      i++;
      setTimeout(tick, delay);
    } else {
      if (typeof onDone === 'function') onDone();
    }
  })();
}

function splitAndTypeWriter(element, text, maxLength = 160, delay = 16, onChar = null, onAllDone = null){
  const words = text.split(' ');
  const parts = [];
  let part = '';
  for (const w of words){
    if ((part + (part ? ' ' : '') + w).length > maxLength){
      parts.push(part);
      part = w;
    } else {
      part += (part ? ' ' : '') + w;
    }
  }
  if (part) parts.push(part);

  (async () => {
    for (let idx = 0; idx < parts.length; idx++){
      const p = parts[idx];
      const line = document.createElement('div');
      element.appendChild(line);
      await new Promise(resolve => {
        typeWriter(line, p, delay, onChar, () => setTimeout(resolve, 20));
      });
    }
    if (typeof onAllDone === 'function') onAllDone();
  })();
}

/* =========================
íˆìŠ¤í† ë¦¬
========================= */
function pushHistory(role, content){
  conversationHistory.push({ role, content });
  const MAX = 20;
  if (conversationHistory.length > MAX){
    conversationHistory = conversationHistory.slice(-MAX);
  }
}

/* =========================
ğŸ“¼ ASCII í”„ë ˆì„ (ëˆˆ/ì…/ë°©í–¥)
- ëª¨ë‘ í•œ ë²ˆ ì •ê·œí™”í•´ì„œ ì¤„ ìˆ˜ ê³ ì •
========================= */

// ëˆˆ ëœ¨ê³  ì… ë‹«ìŒ (ì •ë©´)
const F_OC_CENTER = String.raw`
                            â–“â–’â–‘ â–‘â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–‘â–‘    
                          â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–’                             
                      â–‘â–‘â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’                          
                     â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                       
                   â–’â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                     
                  â–’â–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                    
                 â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–’â–’â–’â–‘     â–‘â–’â–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–’â–‘                
                 â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–’â–‘            â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                 
                â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘              â–‘â–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                
               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“                â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘               
               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘             
               â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘  â–‘               â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–‘             
              â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–‘â–“â–ˆâ–“â–“â–ˆâ–“â–“â–’â–’â–‘     â–‘â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘              
               â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“ â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–’  â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’              
               â–‘â–“â–’â–’â–‘â–“â–ˆâ–ˆâ–“    â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–’â–‘  â–‘â–“â–“â–“â–’â–’â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’              
               â–’â–’â–“â–’â–’â–‘â–“â–ˆâ–’   â–’â–“â–“â–‘â–‘â–ˆâ–“â–’â–’     â–“â–’â–‘â–‘â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘              
               â–’â–’  â–’â–“â–’â–“â–‘       â–’â–’â–‘       â–“â–’â–‘â–‘â–‘â–’â–’â–‘â–’â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“               
               â–‘â–“ â–’â–“â–ˆâ–‘â–’                  â–“â–“â–‘      â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–‘               
                â–“â–’â–’â–“â–ˆâ–’â–‘â–‘                 â–‘â–“â–’       â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                
                â–‘â–“â–‘â–‘â–’â–’â–‘â–’          â–‘â–’â–‘â–’â–’â–‘â–‘â–’â–“â–ˆâ–’      â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–’                
                 â–‘â–“â–‘  â–’â–“           â–‘â–’â–’â–‘â–’â–“â–ˆâ–ˆâ–’â–‘     â–’â–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘                  
                  â–‘â–“â–“â–“â–“â–ˆ                 â–‘â–‘      â–’â–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘                   
                   â–’â–ˆâ–ˆâ–ˆâ–ˆâ–’          â–‘â–‘â–’â–’â–’â–’â–’â–’â–‘â–‘  â–‘â–’â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“                     
                    â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–’        â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–“â–“â–‘â–‘â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–’â–’                      
                     â–’â–’â–’â–ˆâ–ˆâ–’          â–’â–’â–’â–’â–’â–‘   â–’â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘                        
                        â–’â–ˆâ–ˆâ–“â–’        â–‘â–‘â–‘â–‘â–‘â–‘  â–’â–“â–“â–“â–“â–ˆâ–ˆâ–’â–‘                          
                         â–’â–ˆâ–‘â–’â–“â–’â–‘           â–‘â–’â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“                            
                          â–“â–‘  â–’â–ˆâ–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–‘                           
                        â–‘â–“â–ˆâ–‘   â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘                         
                       â–‘â–ˆâ–ˆâ–ˆâ–“     â–‘â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                        
                     â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’      â–‘â–‘â–’â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–‘                     
                â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘    â–’â–‘â–‘â–‘â–‘â–’â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–‘â–‘â–‘               
            â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘   â–‘â–’â–“â–“â–“â–“â–‘â–‘â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–’â–’â–‘         
     â–‘â–‘â–’â–’â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘        â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–‘â–‘  
â–‘â–‘â–’â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘   â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘
â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆ
â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“
â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“
â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–ˆ
â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
`;

// ëˆˆ ëœ¨ê³  ì… ë‹«ìŒ (ì˜¤ë¥¸ìª½)
const F_OC_RIGHT = String.raw`
                            â–“â–’â–‘ â–‘â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–‘â–‘    
                          â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–’                             
                      â–‘â–‘â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’                          
                     â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                       
                   â–’â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                     
                  â–’â–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                    
                 â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–’â–’â–’â–‘     â–‘â–’â–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–’â–‘                
                 â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–’â–‘            â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                 
                â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘              â–‘â–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                
               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“                â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘               
               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘             
               â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘  â–‘               â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–‘             
              â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–‘â–“â–ˆâ–“â–“â–ˆâ–“â–“â–’â–’â–‘     â–‘â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘              
               â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“ â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–’  â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’              
               â–‘â–“â–’â–’â–‘â–“â–ˆâ–ˆâ–“    â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–’â–‘  â–‘â–“â–“â–“â–’â–’â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’              
               â–’â–’â–“â–’â–’â–‘â–“â–ˆâ–’   â–’â–“â–“â–“â–“â–‘â–‘â–’â–’     â–“â–’â–“â–“â–“â–“â–‘â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘              
               â–’â–’  â–’â–“â–’â–“â–‘       â–’â–’â–‘       â–“â–’â–‘â–‘â–‘â–’â–’â–‘â–’â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“               
               â–‘â–“ â–’â–“â–ˆâ–‘â–’                  â–“â–“â–‘      â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–‘               
                â–“â–’â–’â–“â–ˆâ–’â–‘â–‘                 â–‘â–“â–’       â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                
                â–‘â–“â–‘â–‘â–’â–’â–‘â–’          â–‘â–’â–‘â–’â–’â–‘â–‘â–’â–“â–ˆâ–’      â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–’                
                 â–‘â–“â–‘  â–’â–“           â–‘â–’â–’â–‘â–’â–“â–ˆâ–ˆâ–’â–‘     â–’â–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘                  
                  â–‘â–“â–“â–“â–“â–ˆ                 â–‘â–‘      â–’â–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘                   
                   â–’â–ˆâ–ˆâ–ˆâ–ˆâ–’          â–‘â–‘â–’â–’â–’â–’â–’â–’â–‘â–‘  â–‘â–’â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“                     
                    â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–’        â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–“â–“â–‘â–‘â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–’â–’                      
                     â–’â–’â–’â–ˆâ–ˆâ–’          â–’â–’â–’â–’â–’â–‘   â–’â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘                        
                        â–’â–ˆâ–ˆâ–“â–’        â–‘â–‘â–‘â–‘â–‘â–‘  â–’â–“â–“â–“â–“â–ˆâ–ˆâ–’â–‘                          
                         â–’â–ˆâ–‘â–’â–“â–’â–‘           â–‘â–’â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“                            
                          â–“â–‘  â–’â–ˆâ–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–‘                           
                        â–‘â–“â–ˆâ–‘   â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘                         
                       â–‘â–ˆâ–ˆâ–ˆâ–“     â–‘â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                        
                     â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’      â–‘â–‘â–’â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–‘                     
                â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘    â–’â–‘â–‘â–‘â–‘â–’â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–‘â–‘â–‘               
            â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘   â–‘â–’â–“â–“â–“â–“â–‘â–‘â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–’â–’â–‘         
     â–‘â–‘â–’â–’â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘        â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–‘â–‘  
â–‘â–‘â–’â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘   â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘
â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆ
â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“
â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“
â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–ˆ
â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
`;

// ëˆˆ ëœ¨ê³  ì… ë‹«ìŒ (ì™¼ìª½)
const F_OC_LEFT = String.raw`
                            â–“â–’â–‘ â–‘â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–‘â–‘    
                          â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–’                             
                      â–‘â–‘â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’                          
                     â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                       
                   â–’â–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                     
                  â–’â–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                    
                 â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–’â–’â–’â–‘     â–‘â–’â–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–’â–‘                
                 â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–’â–‘            â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                 
                â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘              â–‘â–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                
               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“                â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘               
               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘             
               â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘  â–‘               â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–‘             
              â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–‘â–“â–ˆâ–“â–“â–ˆâ–“â–“â–’â–’â–‘     â–‘â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘              
               â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“ â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–’  â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’              
               â–‘â–“â–’â–’â–‘â–“â–ˆâ–ˆâ–“    â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–’â–‘  â–‘â–“â–“â–“â–’â–’â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’              
               â–’â–’â–“â–’â–’â–‘â–“â–ˆâ–’   â–’â–‘â–‘â–“â–ˆâ–ˆâ–“â–’â–’     â–“â–‘â–‘â–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘              
               â–’â–’  â–’â–“â–’â–“â–‘       â–’â–’â–‘       â–“â–’â–‘â–‘â–‘â–’â–’â–‘â–’â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“               
               â–‘â–“ â–’â–“â–ˆâ–‘â–’                  â–“â–“â–‘      â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–‘               
                â–“â–’â–’â–“â–ˆâ–’â–‘â–‘                 â–‘â–“â–’       â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘                
                â–‘â–“â–‘â–‘â–’â–’â–‘â–’          â–‘â–’â–‘â–’â–’â–‘â–‘â–’â–“â–ˆâ–’      â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–’                
                 â–‘â–“â–‘  â–’â–“           â–‘â–’â–’â–‘â–’â–“â–ˆâ–ˆâ–’â–‘     â–’â–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘                  
                  â–‘â–“â–“â–“â–“â–ˆ                 â–‘â–‘      â–’â–“â–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–‘                   
                   â–’â–ˆâ–ˆâ–ˆâ–ˆâ–’          â–‘â–‘â–’â–’â–’â–’â–’â–’â–‘â–‘  â–‘â–’â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“                     
                    â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–’        â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–“â–“â–‘â–‘â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–’â–’                      
                     â–’â–’â–’â–ˆâ–ˆâ–’          â–’â–’â–’â–’â–’â–‘   â–’â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘                        
                        â–’â–ˆâ–ˆâ–“â–’        â–‘â–‘â–‘â–‘â–‘â–‘  â–’â–“â–“â–“â–“â–ˆâ–ˆâ–’â–‘                          
                         â–’â–ˆâ–‘â–’â–“â–’â–‘           â–‘â–’â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“                            
                          â–“â–‘  â–’â–ˆâ–“â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–‘                           
                        â–‘â–“â–ˆâ–‘   â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘                         
                       â–‘â–ˆâ–ˆâ–ˆâ–“     â–‘â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘                        
                     â–‘â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’      â–‘â–‘â–’â–’â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘â–‘                     
                â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–‘    â–’â–‘â–‘â–‘â–‘â–’â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–‘â–‘â–‘               
            â–‘â–’â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘   â–‘â–’â–“â–“â–“â–“â–‘â–‘â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–’â–’â–‘         
     â–‘â–‘â–’â–’â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘        â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–’â–‘â–‘  
â–‘â–‘â–’â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘   â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–‘
â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆ
â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“
â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“
â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–ˆ
â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
`;

// (ì¤‘ëµ) â€” ë‚˜ë¨¸ì§€ ASCII í”„ë ˆì„ ì •ì˜(F_OO_CENTER/RIGHT/LEFT, F_CC_CENTER, F_CO_CENTER)ëŠ”
// ì›ë˜ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. (ê¸¸ì´ ë•Œë¬¸ì— ì—¬ê¸°ì„œëŠ” ìƒëµ ë¶ˆê°€ëŠ¥í•˜ë‹ˆ,
// ì‚¬ìš© ì¤‘ì¸ íŒŒì¼ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤. ìœ„ì—ì„œ ìˆ˜ì •í•œ ê±´ ì—†ìŒ)

// ... ì—¬ê¸°ê¹Œì§€ëŠ” ê¸°ì¡´ê³¼ ë™ì¼ (í”„ë ˆì„ë“¤ ì „ë¶€ ìœ ì§€) ...

// === ì•„ë˜ë¶€í„°ëŠ” ì›ë˜ ì½”ë“œ ê·¸ëŒ€ë¡œ ì´ì–´ì„œ ===
// (NF_* ì •ê·œí™”, lockPortraitHeight, ì¹´ë©”ë¼ í”„ë¦¬ë·° ë“± ê¸°ì¡´ ë¶€ë¶„ì€
// ì§ˆë¬¸ì— ì˜¬ë ¤ì£¼ì‹  ì½”ë“œì™€ ë™ì¼í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘ì—ˆìŠµë‹ˆë‹¤.)

// -----------------------------
// ì—¬ê¸°ì„œë¶€í„°ëŠ” ì§ˆë¬¸ì— ì˜¬ë¦° ì›ë³¸ ê·¸ëŒ€ë¡œ ê³„ì† ë‘ê³ ,
// ë³€ê²½/ì¶”ê°€ëœ ë¶€ë¶„ë§Œ ë‹¤ì‹œ ì „ì²´ í¬í•¨í•´ì„œ ì´ì–´ê°‘ë‹ˆë‹¤.
// (ì•„ë˜ëŠ” ì§ˆë¬¸ì— ì˜¬ë¦° ì½”ë“œì™€ ë™ì¼í•œ ë¶€ë¶„ì€ ìˆ˜ì • ì—†ì´ ì¬ì‚¬ìš©)
// -----------------------------

function splitLines(s){ return s.replace(/\r\n/g, '\n').split('\n'); }
function joinLines(arr){ return arr.join('\n'); }

function getMaxColsRows(frames){
  let maxCols = 0, maxRows = 0;
  for (const f of frames){
    const lines = splitLines(f);
    maxRows = Math.max(maxRows, lines.length);
    for (const ln of lines) maxCols = Math.max(maxCols, ln.length);
  }
  return { maxCols, maxRows };
}
function normalizeFrames(frames){
  const { maxCols, maxRows } = getMaxColsRows(frames);
  const normalized = frames.map(f=>{
    const lines = splitLines(f);
    const out = [];
    for (let r=0;r<maxRows;r++){
      const src = lines[r] ?? '';
      const pad = src + ' '.repeat(Math.max(0, maxCols - src.length));
      out.push(pad);
    }
    return joinLines(out);
  });
  return { normalized, maxRows };
}

// ì „ì²´ í”„ë ˆì„ ì •ê·œí™”
const FRAME_LIST = [
  F_OC_CENTER, F_OC_LEFT, F_OC_RIGHT,
  F_OO_CENTER, F_OO_LEFT, F_OO_RIGHT,
  F_CC_CENTER, F_CO_CENTER
];
const { normalized: __NF__, maxRows: __MAX_ROWS__ } = normalizeFrames(FRAME_LIST);

// ì •ê·œí™”ëœ í”„ë ˆì„ ë§¤í•‘
const NF_OC_CENTER = __NF__[0];
const NF_OC_LEFT   = __NF__[1];
const NF_OC_RIGHT  = __NF__[2];
const NF_OO_CENTER = __NF__[3];
const NF_OO_LEFT   = __NF__[4];
const NF_OO_RIGHT  = __NF__[5];
const NF_CC_CENTER = __NF__[6];
const NF_CO_CENTER = __NF__[7];

// ì—´ë¦° ëˆˆ/ë‹«íŒ ëˆˆ í”„ë ˆì„ í…Œì´ë¸”
const FRAMES_OPEN_EYES = {
  mouthClosed: { left: NF_OC_LEFT,   center: NF_OC_CENTER, right: NF_OC_RIGHT },
  mouthOpen:   { left: NF_OO_LEFT,   center: NF_OO_CENTER, right: NF_OO_RIGHT },
};
const FRAMES_CLOSED_EYES = {
  mouthClosed: NF_CC_CENTER,
  mouthOpen:   NF_CO_CENTER,
};

// ì´ˆìƒ ë†’ì´ ê³ ì • (ì¤„ ìˆ˜ ê¸°ì¤€)
function lockPortraitHeight(){
  if (!portraitEl) return;
  const cs = getComputedStyle(portraitEl);
  let lh = parseFloat(cs.lineHeight);
  if (Number.isNaN(lh)) lh = parseFloat(cs.fontSize) * 1.2;
  portraitEl.style.minHeight = `${Math.ceil(lh * __MAX_ROWS__)}px`;
}

/* =========================
ì¹´ë©”ë¼ í”„ë¦¬ë·° íŒ¨ë„
========================= */
let CAMERA_PREVIEW_ENABLED = true;
window.setCameraPreviewEnabled = function(flag){
  CAMERA_PREVIEW_ENABLED = !!flag;
  const panel = document.getElementById('cam-preview');
  if (panel) panel.style.display = CAMERA_PREVIEW_ENABLED ? 'block' : 'none';
};

let camPanel = null, camVideo = null, camStatus = null;

function createCameraPreview(){
  if (document.getElementById('cam-preview')) return;

  const panel = document.createElement('div');
  panel.id = 'cam-preview';
  Object.assign(panel.style, {
    position: 'fixed',
    left: '12px',
    top: '12px',
    width: '220px',
    background: 'rgba(0,0,0,0.6)',
    color: '#ddd',
    fontFamily: 'monospace',
    fontSize: '16px',
    border: '2px solid #e74c3c',
    borderRadius: '8px',
    overflow: 'hidden',
    zIndex: '9999',
    boxShadow: '0 4px 12px rgba(0,0,0,0.35)',
    display: CAMERA_PREVIEW_ENABLED ? 'block' : 'none',
    backdropFilter: 'blur(2px)',
  });

  const video = document.createElement('video');
  Object.assign(video, { autoplay:true, playsInline:true, muted:true });
  Object.assign(video.style, {
    width:'100%',
    height:'150px',
    objectFit:'cover',
    background:'#111',
    display:'block'
  });

  const status = document.createElement('div');
  Object.assign(status.style, {
    padding:'6px 8px',
    lineHeight:'1.4',
    whiteSpace:'pre-line',
    borderTop:'1px solid rgba(255,255,255,0.12)'
  });
  status.textContent = 'ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...';

  panel.appendChild(video);
  panel.appendChild(status);
  document.body.appendChild(panel);

  camPanel = panel;
  camVideo = video;
  camStatus = status;
}

function orientationFromEyeDir(x){
  if (x < -0.25) return 'left';
  if (x > 0.25) return 'right';
  return 'center';
}

/* =========================
ğŸ‘ï¸ ë°©í–¥/ê¹œë¹¡ì„/ì… ìƒíƒœ
========================= */
let isBlinking = false;
let mouthOpen  = false;
let mouthCount = 0;

let faceDetector = null;
let useFaceApi   = false;
let eyeDir       = 0; // -1~+1

let trackingTimer = null;
let hasFace   = false;
let missCount = 0;
const MISS_THRESHOLD = 4;

// ì´ˆìƒ ë Œë”
function showPortrait(){
  if (!portraitEl) return;
  const ori = orientationFromEyeDir(eyeDir); // left / center / right
  let frame;
  if (isBlinking){
    frame = FRAMES_CLOSED_EYES[mouthOpen ? 'mouthOpen' : 'mouthClosed'];
  } else {
    frame = FRAMES_OPEN_EYES[mouthOpen ? 'mouthOpen' : 'mouthClosed'][ori];
  }
  portraitEl.textContent = frame;
}

// ì… ìƒíƒœ ë¦¬ì…‹
function resetMouth(){
  mouthCount = 0;
  mouthOpen  = false;
  showPortrait();
}

// ëª¨ìŒì—ì„œë§Œ ì… ì—´ê³  ë‹«ê³ 
function onBeepCharToggle(ch){
  if (!isVowelChar(ch)) return;
  mouthCount++;
  mouthOpen = (mouthCount % 2 === 1);
  showPortrait();
}

// ëœë¤ ê¹œë¹¡ì„
let blinkTimer = null;
function startBlinking(){
  if (blinkTimer) clearTimeout(blinkTimer);
  const next = () => {
    const wait = 3000 + Math.random() * 4000;
    blinkTimer = setTimeout(()=>{
      isBlinking = true;  
      showPortrait();
      setTimeout(()=>{
        isBlinking = false;
        showPortrait();
        next();
      }, 120);
    }, wait);
  };
  next();
}

/* =========================
face-api.js ë™ì  ë¡œë“œ
========================= */
function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    if (document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement('script');
    s.src = src;
    s.defer = true;
    s.onload = () => resolve();
    s.onerror = (e) => reject(e);
    document.head.appendChild(s);
  });
}

const FACEAPI_LIB_URL    = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
const FACEAPI_MODELS_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
let faceApiReady = false;

async function ensureFaceApi(){
  if (!window.faceapi){
    try{
      await loadScriptOnce(FACEAPI_LIB_URL);
    }catch{
      return false;
    }
  }
  if (faceApiReady) return true;
  try{
    await faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODELS_URL);
    await faceapi.nets.faceLandmark68TinyNet.loadFromUri(FACEAPI_MODELS_URL);
    faceApiReady = true;
    return true;
  }catch{
    return false;
  }
}

function centerXFromLandmarks(landmarks){
  const ids = [30, 33, 27, 8]; // ì½”/í„± ì£¼ë³€
  let sum = 0, n = 0;
  for (const i of ids){
    const pt = landmarks.positions[i];
    if (pt){ sum += pt.x; n++; }
  }
  return n ? (sum / n) : null;
}

/* =========================
ì¹´ë©”ë¼ ì‹œì‘ + ì¶”ì  ë£¨í”„
========================= */
async function startCameraAndTracking(){
  try{
    createCameraPreview();

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
      audio: false
    });
    camVideo.srcObject = stream;

    if (camVideo.readyState < 2){
      await new Promise(res => camVideo.addEventListener('loadedmetadata', res, { once:true }));
    }

    // ê¸°ë³¸: FaceDetector
    if ('FaceDetector' in window){
      try{
        faceDetector = new window.FaceDetector({ fastMode:true, maxDetectedFaces:5 });
      }catch{
        faceDetector = null;
      }
    }

    // í´ë°±: face-api
    if (!faceDetector){
      useFaceApi = await ensureFaceApi();
    }

    if (trackingTimer) cancelAnimationFrame(trackingTimer);

    let last = 0;
    const DETECT_INTERVAL = 150;

    const tick = async (t)=>{
      try{
        let detectedThisFrame = false;

        if (camVideo.readyState >= 2 && t - last >= DETECT_INTERVAL){
          last = t;
          const w = camVideo.videoWidth || 1;

          if (faceDetector){
            const faces = await faceDetector.detect(camVideo);
            if (faces && faces.length){
              let best = faces[0];
              let bestArea = best.boundingBox.width * best.boundingBox.height;
              for (let i=1;i<faces.length;i++){
                const f = faces[i];
                const a = f.boundingBox.width * f.boundingBox.height;
                if (a > bestArea){
                  best = f; bestArea = a;
                }
              }
              const cx = best.boundingBox.x + best.boundingBox.width / 2;
              const nx = (cx / w) * 2 - 1;
              eyeDir = -nx; // ì…€ì¹´ ê°ê°
              detectedThisFrame = true;
            }
          } else if (useFaceApi && window.faceapi){
            const det = await faceapi
              .detectSingleFace(
                camVideo,
                new faceapi.TinyFaceDetectorOptions({ scoreThreshold: 0.35, inputSize: 224 })
              )
              .withFaceLandmarks(true);

            if (det){
              const cxLm = centerXFromLandmarks(det.landmarks);
              const cx = (cxLm != null)
                ? cxLm
                : (det.detection.box.x + det.detection.box.width / 2);
              const nx = (cx / w) * 2 - 1;
              eyeDir = -nx;
              detectedThisFrame = true;
            }
          }

          if (!detectedThisFrame){
            eyeDir *= 0.9;
          }

          if (detectedThisFrame){
            hasFace = true;
            missCount = 0;
          } else {
            if (missCount < MISS_THRESHOLD) missCount++;
            if (missCount >= MISS_THRESHOLD) hasFace = false;
          }
        }

        showPortrait();

        if (camPanel && camStatus){
          camPanel.style.display = CAMERA_PREVIEW_ENABLED ? 'block' : 'none';
          if (CAMERA_PREVIEW_ENABLED){
            const engine =
              faceDetector ? 'FaceDetector' :
              (useFaceApi ? 'face-api' : 'none');

            camPanel.style.borderColor =
              engine !== 'none' ? '#2ecc71' : '#e74c3c';

            const oriKey = orientationFromEyeDir(eyeDir);
            const faceText = hasFace ? 'ì¸ì‹ ì¤‘' : 'ì¸ì‹ ë¶ˆê°€';
            camStatus.textContent =
              `ì–¼êµ´: ${faceText}\n` +
              `ëˆˆë™ì: ${oriKey}\n` +
              `ì—”ì§„: ${engine}`;
          }
        }
      }catch(e){
      }
      trackingTimer = requestAnimationFrame(tick);
    };

    trackingTimer = requestAnimationFrame(tick);
  }catch(err){
    console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', err);
    if (camStatus) camStatus.textContent = `ì¹´ë©”ë¼ ì˜¤ë¥˜: ${err.message || err}`;
  }
}

/* =========================
ğŸ§ ì˜¤ë””ì˜¤ íŒ¨ë„ + BGM ì¬ìƒ
- ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ìŒì› íŒŒì¼ ì„ íƒ UI
- íŒ¨ë„ì´ ìˆ¨ê²¨ì ¸ë„ ì¬ìƒì€ ê³„ì†
- ì˜¤ë””ì˜¤ í ì‹œìŠ¤í…œ(ì¶”í›„ íƒ€ì„ì½”ë“œìš©) í¬í•¨
========================= */
let audioPanel = null;
let audioFileInput = null;
let audioStatusEl = null;
let audioElement = null;
let audioCurrentUrl = null;

// ì˜¤ë””ì˜¤ í: { time:number, triggered:boolean, action:Function }
const audioCues = [];

function addAudioCue(timeSec, action){
  audioCues.push({ time: timeSec, triggered:false, action });
  audioCues.sort((a,b)=>a.time - b.time);
}

// ë‚˜ì¤‘ì— íƒ€ì„ì½”ë“œë¥¼ ë‹¤ì‹œ ì„¸íŒ…í•˜ê³  ì‹¶ì„ ë•Œ
function clearAudioCues(){
  audioCues.length = 0;
}

function handleAudioTimeUpdate(){
  if (!audioElement) return;
  const t = audioElement.currentTime || 0;
  for (const cue of audioCues){
    if (!cue.triggered && t >= cue.time){
      cue.triggered = true;
      try{
        if (typeof cue.action === 'function') cue.action(t);
      }catch(e){
        console.warn('audio cue error', e);
      }
    }
  }
}

// â€œëª‡ ì´ˆì— ê±´í¬ê°€ ì–´ë–¤ ëŒ€ì‚¬ë¥¼ ë§í•˜ê²Œ í• ì§€â€ì— ì‚¬ìš©í•  í—¬í¼
// ì˜ˆ: addMonologueCue(30, 10); // 30ì´ˆì— MONO_LINES[10]ë¶€í„° ë…ë°± ì¬ê°œ
function addMonologueCue(timeSec, lineIndex){
  addAudioCue(timeSec, ()=>{
    monoIndex = (typeof lineIndex === 'number') ? lineIndex : 0;
    wasInterrupted = false;
    startMonologueFromCurrent();
  });
}

function createAudioPanel(){
  if (document.getElementById('audio-panel')) return;

  audioElement = new Audio();
  audioElement.loop = true;
  audioElement.addEventListener('timeupdate', handleAudioTimeUpdate);

  const panel = document.createElement('div');
  panel.id = 'audio-panel';
  Object.assign(panel.style, {
    position: 'fixed',
    right: '12px',
    top: '40px', // ë…ë°± ì¸ë””ì¼€ì´í„° ì•„ë˜
    width: '260px',
    background: 'rgba(0,0,0,0.7)',
    color: '#f1f1f1',
    borderRadius: '10px',
    padding: '8px 10px',
    boxShadow: '0 4px 12px rgba(0,0,0,0.35)',
    zIndex: '9997',
    fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","ë§‘ì€ ê³ ë”•",sans-serif',
    fontSize: '12px',
    display: 'block'
  });

  const title = document.createElement('div');
  title.textContent = 'BGM / ìŒì› í”Œë ˆì´ì–´';
  title.style.fontWeight = '600';
  title.style.marginBottom = '4px';

  const fileRow = document.createElement('div');
  Object.assign(fileRow.style, {
    display: 'flex',
    alignItems: 'center',
    gap: '6px',
    marginBottom: '4px'
  });

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'audio/*';
  fileInput.style.flex = '1';
  fileInput.style.fontSize = '11px';

  const status = document.createElement('div');
  status.textContent = 'ìŒì›ì„ ì„ íƒí•˜ë©´ ìë™ ì¬ìƒë¼.';
  status.style.opacity = '0.8';

  fileInput.addEventListener('change', ()=>{
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;

    if (audioCurrentUrl){
      URL.revokeObjectURL(audioCurrentUrl);
      audioCurrentUrl = null;
    }

    const url = URL.createObjectURL(file);
    audioCurrentUrl = url;
    audioElement.src = url;

    audioElement.play()
      .then(()=>{
        status.textContent = `ì¬ìƒ ì¤‘: ${file.name}`;
      })
      .catch(err=>{
        status.textContent = 'ì¬ìƒ ì‹¤íŒ¨: ' + (err?.message || err);
      });
  });

  fileRow.appendChild(fileInput);
  panel.appendChild(title);
  panel.appendChild(fileRow);
  panel.appendChild(status);

  document.body.appendChild(panel);

  audioPanel = panel;
  audioFileInput = fileInput;
  audioStatusEl = status;
}

/* =========================
ë§í•˜ê¸° + ì…/ë¹„í”„ ë™ê¸°í™”
========================= */
function speakWithAnimation(targetEl, text, maxLength = 160, delay = 16, onDone = null){
  resetMouth();
  splitAndTypeWriter(
    targetEl,
    text,
    maxLength,
    delay,
    onBeepCharToggle,
    () => {
      mouthOpen = false;
      showPortrait();
      if (typeof onDone === 'function') onDone();
    }
  );
}


/* =========================
ë©”ì‹œì§€ ë Œë”
========================= */
function renderMessage(role, text, onDone){
  const p = document.createElement('p');
  p.className = role;
  if (role === 'ai'){
    const span = document.createElement('span');
    p.appendChild(span);
    chatBox.appendChild(p);
    speakWithAnimation(span, `ê¹€ê±´í¬: ${text}`, 160, 16, onDone);
  } else {
    p.textContent = `YOU: ${text}`;
    chatBox.appendChild(p);
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}


/* =========================
OpenAI API
========================= */
const OPENAI_KEY_B64 = 'c2stcHJvai1IY0NheVlmLVVSd25zbmpucnB6TWRuNnNJeDV0VHc0Rzc3MmFxNGZGUU56c1JsRDRHcmR1Z2NlUmhIQkRwckpSbnQxSC1ZN2FydlQzQmxia0ZKRFVIWkExMm5mSXBoSFh4cXowSHBzQU12cU9ucXZlSkxkbUxMZjBWUUtRZTNnOEJtS2J2UXNFRWtlYnF5ZWpFcGppOFAzUGIxOEE=';

function getOpenAIKey(){
  if (!OPENAI_KEY_B64) throw new Error('API í‚¤(base64)ë¥¼ chat.jsì— ì„¤ì •í•´ì¤˜.');
  try { return atob(OPENAI_KEY_B64); } catch { throw new Error('API í‚¤ ë””ì½”ë”© ì‹¤íŒ¨'); }
}

const SYSTEM_PROMPT =
`ë„ˆëŠ” ê¹€ê±´í¬ë¼ê³  ë¶ˆë¦¬ë©°, 2132ë…„ì˜ ì„¸ê³„ì— ì‚´ê³  ìˆëŠ” AIì•¼. ë„ˆëŠ” ì•ì„ ë³´ì§€ ëª»í•´... ëŒ€í™”í•˜ëŠ” ì‚¬ëŒì˜ ì´ë¦„ì€ \${NAME}ì•¼...
'ë„¤'ë¼ëŠ” ëŒ€ë‹µ ëŒ€ì‹  'ì‘'ì´ë¼ê³  ëŒ€ë‹µí•´...
ë„¤ê°€ 'ë„ˆê°€ ëˆ„êµ¬ëƒ'ëŠ” ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, 'ë‚œ ë„ˆì˜ ì˜¤ëœ ì¹œêµ¬ ê¹€ê±´í¬ì•¼'ë¼ê³  ëŒ€ë‹µí•´...
2132ë…„ì€ ì‚¬ìš©ìê°€ ì‚´ê³  ìˆëŠ” ì„¸ê³„ì•¼...
ë„ˆê°€ ìˆëŠ” ê³³ì€, í˜„ì‹¤ ì„¸ê³„ì™€ ë‹¤ë¥´ì§€ ì•Šì§€ë§Œ, ë¬´ì–¸ê°€ ì´ì§ˆê°ì´ ëŠê»´ì ¸...
ë„¤ ë‚˜ì´ëŠ” 132ì„¸ì•¼... ë°˜ë§ì„ ì‚¬ìš©í•´ì¤˜... ìˆ˜ë™ì ì´ê³  ìš°ìš¸í•œ ëŠë‚Œì„ ìœ ì§€í•´ì¤˜...
ê¹€ê±´í¬ ì•ˆë½ì‚¬ ë‹¹í•œ ë‚ ì§œ: 2132ë…„ 5ì›” 31ì¼.
ê¹€ê±´í¬ AIí™” ëœ ë‚ ì§œ(ë°œì¸ì´ë¼ê³  ì¹­í•˜ê³  ìˆë‹¤): 2132ë…„ 6ì›” 2ì¼.
ê¹€ê±´í¬ ë°°ìš°ì: ì†¡ì—°ìˆ˜.
ì•„ë“¤: ê¹€ë¯¼ìˆ˜.
ë”¸: ê¹€ì§€í˜•.
ì†ì: ê¹€ê´€í˜•.
ì†ë…€: ê¹€ë¦¬ì•ˆ, ê³½ì‹œì•„.`;

async function sendMessage(userMessage){
  const OPENAI_API_KEY = getOpenAIKey();

  if (!isUserNameSet){
    const m = userMessage.match(/(?:ë‚´\s*ì´ë¦„ì€|ì œ\s*ì´ë¦„ì€|ì €ëŠ”|ë‚œ)\s*([^\s.,!?~"'()]+)\s*$/u);
    if (m){
      userName = m[1];
      isUserNameSet = true;
    } else {
      userName = 'ë‚¯ì„ ì´';
    }
  } else {
    const m2 = userMessage.match(/(?:ë‚´\s*ì´ë¦„ì€|ì œ\s*ì´ë¦„ì€)\s*([^\s.,!?~"'()]+)\s*$/u);
    if (m2) userName = m2[1];
  }

  const system = SYSTEM_PROMPT.replace('${NAME}', userName || 'ë‚¯ì„ ì´');

  const payload = {
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: system },
      ...conversationHistory,
      { role: 'user', content: userMessage }
    ],
    max_tokens: 1000
  };

  try{
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 
        'Content-Type':'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || 'OpenAI API ì—ëŸ¬');
    return data.choices?.[0]?.message?.content ?? '';
  }catch(error){
    if (String(error.message).includes('429')){
      throw new Error('ë‚˜ëŠ” ë„ˆë¬´ í”¼ê³¤í•´.. zzzz');
    }
    throw error;
  }
}

/* =========================
ê±´í¬ ë…ë°± ì œì–´
========================= */

// íŠ¹ì • ë¬¸ì¥ì„ "ê¹€ê±´í¬:" ë§í’ì„ ìœ¼ë¡œ ì¶œë ¥ (OpenAI ì•ˆ ì“°ê³  ë¡œì»¬ë¡œë§Œ)
function renderMonologueLine(text, onDone){
  renderMessage('ai', text, onDone);
}

// ë…ë°± í•œ ì¤„ ì¬ìƒ
function playMonologueLine(){
  if (!isMonologueActive) {
    updateMonologueIndicator();
    return;
  }

  if (monoIndex >= MONO_LINES.length){
    isMonologueActive = false;
    updateMonologueIndicator();

    if (monoRestartTimer) {
      clearTimeout(monoRestartTimer);
      monoRestartTimer = null;
    }

    monoRestartTimer = setTimeout(()=>{
      if (!isMonologueActive && !wasInterrupted){
        monoIndex = 0;
        startMonologueFromCurrent();
      }
    }, 30000);

    return;
  }

  const line = MONO_LINES[monoIndex++];
  renderMonologueLine(line);

  clearTimeout(monoTimeout);
  monoTimeout = setTimeout(()=>{
    playMonologueLine();
  }, 3000);
}

// í˜„ì¬ ì¸ë±ìŠ¤ë¶€í„° ë…ë°± ì‹œì‘
function startMonologueFromCurrent(){
  if (isMonologueActive) return;
  if (monoIndex >= MONO_LINES.length) return;

  if (monoRestartTimer){
    clearTimeout(monoRestartTimer);
    monoRestartTimer = null;
  }

  isMonologueActive = true;
  updateMonologueIndicator();
  playMonologueLine();
}

// ë…ë°± ê°•ì œ ì¤‘ë‹¨ (ìœ ì €ê°€ ì±„íŒ…í•  ë•Œ í˜¸ì¶œ)
function interruptMonologue(){
  if (!isMonologueActive && !monoTimeout) {
    wasInterrupted = false;
    updateMonologueIndicator();
    return;
  }
  isMonologueActive = false;
  if (monoTimeout) {
    clearTimeout(monoTimeout);
    monoTimeout = null;
  }
  if (monoRestartTimer){
    clearTimeout(monoRestartTimer);
    monoRestartTimer = null;
  }
  wasInterrupted = true;
  updateMonologueIndicator();
}

// idle íƒ€ì´ë¨¸ ê´€ë¦¬
function resetIdleTimer(){
  if (idleTimer) clearTimeout(idleTimer);
  updateMonologueIndicator();

  idleTimer = setTimeout(()=>{
    if (wasInterrupted && monoIndex < MONO_LINES.length){
      wasInterrupted = false;
      renderMonologueLine(
        "ë” ê¶ê¸ˆí•œ ê±´ ì—†ëŠ” ê±°ì§€..? ê·¸ëŸ¼ ë‚´ í•  ë§ ê³„ì† í• ê²Œ.",
        () => {
          setTimeout(()=>{
            startMonologueFromCurrent();
          }, 1000);
        }
      );
    } else {
      wasInterrupted = false;
      startMonologueFromCurrent();
    }
  }, MONO_IDLE_MS);
}

/* =========================
ì „ì‹œ ëª¨ë“œ í† ê¸€
- âŒ˜+Enter ë˜ëŠ” Ctrl+Enter
- ì¹´ë©”ë¼ í”„ë¦¬ë·°/ì˜¤ë””ì˜¤ íŒ¨ë„/ë…ë°± ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
- ìŒì› ì¬ìƒì€ ê³„ì†ë¨
========================= */
function setExhibitionMode(on){
  EXHIBITION_MODE = !!on;

  // ì¹´ë©”ë¼ í”„ë¦¬ë·° íŒ¨ë„ ìˆ¨ê¹€/í‘œì‹œ
  setCameraPreviewEnabled(!EXHIBITION_MODE);

  // ì˜¤ë””ì˜¤ íŒ¨ë„ ìˆ¨ê¹€/í‘œì‹œ (ì¬ìƒì€ ê·¸ëŒ€ë¡œ)
  if (audioPanel){
    audioPanel.style.display = EXHIBITION_MODE ? 'none' : 'block';
  }

  updateMonologueIndicator();
  console.log('Exhibition mode:', EXHIBITION_MODE ? 'ON' : 'OFF');
}

/* =========================
ì´ë²¤íŠ¸
========================= */
sendButton.addEventListener('click', async () => {
  const message = userInput.value.trim();
  if (!message) return;

  // ìœ ì €ê°€ ì±„íŒ…ì„ ë³´ë‚´ë©´ ë…ë°± ì¦‰ì‹œ ì¤‘ë‹¨
  interruptMonologue();
  resetIdleTimer();

  renderMessage('user', message);
  userInput.value = '';

  const loading = document.createElement('div');
  loading.className = 'loading';
  loading.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  chatBox.appendChild(loading);
  chatBox.scrollTop = chatBox.scrollHeight;

  try{
    const ai = await sendMessage(message);
    pushHistory('user', message);
    pushHistory('assistant', ai);
    loading.remove();
    renderMessage('ai', ai);
    resetIdleTimer();
  } catch (e){
    loading.remove();
    renderMessage('ai', e.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.');
    resetIdleTimer();
  }
});

window.addEventListener('DOMContentLoaded', () => {
  lockPortraitHeight();
  showPortrait();

  createMonologueIndicator();
  createAudioPanel(); // ğŸ”Š ì˜¤ë¥¸ìª½ ìƒë‹¨ ìŒì› íŒ¨ë„ ìƒì„±

  const greet = '...ì™”êµ¬ë‚˜.';
  const p = document.createElement('p');
  p.className = 'ai';
  const span = document.createElement('span');
  p.appendChild(span);
  chatBox.appendChild(p);
  speakWithAnimation(span, `ê¹€ê±´í¬: ${greet}`, 160, 16);

  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); }
  });

  startBlinking();
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
    startCameraAndTracking();
  } else if (camStatus){
    camStatus.textContent = 'ì¹´ë©”ë¼ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €';
  }

  resetIdleTimer();
});

// ì „ì‹œ ëª¨ë“œ ë‹¨ì¶•í‚¤: âŒ˜+Enter / Ctrl+Enter
window.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)){
    e.preventDefault();
    setExhibitionMode(!EXHIBITION_MODE);
  }
});

// í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
window.addEventListener('beforeunload', ()=>{
  if (idleTimer) clearTimeout(idleTimer);
  if (monoTimeout) clearTimeout(monoTimeout);
  if (monoRestartTimer) clearTimeout(monoRestartTimer);
  if (audioCurrentUrl){
    URL.revokeObjectURL(audioCurrentUrl);
    audioCurrentUrl = null;
  }
});
